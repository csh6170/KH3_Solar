from fastapi import FastAPI
from pydantic import BaseModel
import pandas as pd
from sklearn.tree import DecisionTreeClassifier
import uvicorn
import random

# 1. FastAPI ì•± ìƒì„±
app = FastAPI()

# 2. í•™ìŠµ ë°ì´í„° ì¤€ë¹„ (ì‹¤ì œë¡œëŠ” CSV íŒŒì¼ ë“±ì—ì„œ ë¡œë“œí•˜ì§€ë§Œ, í•™ìŠµìš©ìœ¼ë¡œ ì§ì ‘ ìƒì„±)
# 0:ë§‘ìŒ(ê°•ìˆ˜ì—†ìŒ), 1:ë¹„/ëˆˆ
# Label: ì¶”ì²œ ì˜·ì°¨ë¦¼
data = {
    'temp': [30, 28, 25, 24, 20, 18, 15, 12, 10, 5, 0, -5,
             30, 25, 10, 0], # ê¸°ì˜¨
    'rain': [0,  0,  0,  0,  0,  0,  0,  0,  0, 0, 0,  0,
             1,  1,  1,  1], # ê°•ìˆ˜ì—¬ë¶€ (0:ì•ˆì˜´, 1:ì˜´)
    'label': [
        "í–‡ë³•ì´ ëœ¨ê±°ì›Œìš”. ì‹œì›í•œ ë¯¼ì†Œë§¤ë‚˜ ë¦°ë„¨ ì†Œìž¬ë¥¼ ì¶”ì²œí•´ìš”.",
        "ë”ìš´ ë‚ ì”¨ì—” ê°€ë²¼ìš´ ë°˜íŒ”ê³¼ ë°˜ë°”ì§€ê°€ ì¢‹ì•„ìš”.",
        "í™œë™í•˜ê¸° ë”± ì¢‹ì€ ë‚ , ë°˜íŒ”ì— ì–‡ì€ ì…”ì¸ ë¥¼ ê±¸ì³ë³´ì„¸ìš”.",
        "ê°€ë³ê²Œ ìž…ê¸° ì¢‹ì€ ë°˜íŒ”ê³¼ ë©´ë°”ì§€ ì¡°í•©ì´ì—ìš”.",
        "ê¸´íŒ” í‹°ì…”ì¸ ì— ì²­ë°”ì§€ë¡œ ìºì£¼ì–¼í•˜ê²Œ.",
        "íŽ¸ì•ˆí•œ ë§¨íˆ¬ë§¨ì— ê°€ë””ê±´ í•˜ë‚˜ ì±™ê¸°ì„¸ìš”.",
        "ê³µê¸°ê°€ ìŒ€ìŒ€í•´ìš”. í¬ê·¼í•œ ë‹ˆíŠ¸ì™€ ìžì¼“ì´ í•„ìš”í•´ìš”.",
        "ì°¬ ë°”ëžŒì„ ë§‰ì•„ì¤„ íŠ¸ë Œì¹˜ì½”íŠ¸ë‚˜ ì•¼ìƒì´ ì¢‹ê² ì–´ìš”.",
        "íŠ¸ë Œì¹˜ì½”íŠ¸ì— ë„í†°í•œ ë°”ì§€ë¡œ ë³´ì˜¨ì„ ì±™ê¸°ì„¸ìš”.",
        "ì¶”ìš´ ë‚ ì—” ìš¸ ì½”íŠ¸ ì†ì— ížˆíŠ¸í…ì„ ê¼­ ì±™ê²¨ ìž…ìœ¼ì„¸ìš”.",
        "ë„ˆë¬´ ì¶”ì›Œìš”! ë”°ëœ»í•œ íŒ¨ë”©ê³¼ ëª©ë„ë¦¬ë¡œ ë¬´ìž¥í•˜ì„¸ìš”.",
        "ì‚´ì„ ì—ëŠ” í˜¹í•œê¸°ì—” ë¡±íŒ¨ë”©ê³¼ ë°©í•œìš©í’ˆì´ í•„ìˆ˜ì˜ˆìš”.",
        "ë¹„ ì˜¤ê³  í›„ë¥ì§€ê·¼í•  ë• ë°˜íŒ”ì— ë ˆì¸ë¶€ì¸ ê°€ ë”±ì´ì£ .",
        "ë¹„ ì˜¤ëŠ” ë‚ ì—” í™œë™ì„± ì¢‹ì€ ë°˜íŒ”ê³¼ ìš°ë¹„ë¥¼ ì¶”ì²œí•´ìš”.",
        "ìŒ€ìŒ€í•œ ë¹—ê¸¸ì—” íŠ¸ë Œì¹˜ì½”íŠ¸ì™€ ìš°ì‚°ì„ ì±™ê¸°ì„¸ìš”.",
        "ëˆˆ ì˜¤ëŠ” ë‚ , íŒ¨ë”©ê³¼ ë¯¸ë„ëŸ¼ ë°©ì§€ ì‹ ë°œë¡œ ì•ˆì „í•˜ê²Œ."
    ]
}

# 3. ëª¨ë¸ í•™ìŠµ (ì„œë²„ ì‹œìž‘ ì‹œ 1íšŒ ì‹¤í–‰)
df = pd.DataFrame(data)
X = df[['temp', 'rain']]
y = df['label']

model = DecisionTreeClassifier()
model.fit(X, y)
print("âœ¨âœ¨âœ¨âœ¨âœ¨ AI ëª¨ë¸ í•™ìŠµ ì™„ë£Œ! (Decision Tree)âœ¨âœ¨âœ¨âœ¨âœ¨")


# 4. ìš”ì²­ ë°ì´í„° êµ¬ì¡° ì •ì˜ (DTO ì—­í• )
class WeatherRequest(BaseModel):
    temp: float
    pty: str  # ê¸°ìƒì²­ ì½”ë“œ ("0", "1", "ë¹„" ë“±)

# 5. ì˜ˆì¸¡ API ì—”ë“œí¬ì¸íŠ¸
@app.post("/predict")
def predict_outfit(req: WeatherRequest):
    # ë°ì´í„° ì „ì²˜ë¦¬: ê¸°ìƒì²­ PTY ì½”ë“œë¥¼ 0(ë§‘ìŒ) ë˜ëŠ” 1(ë¹„/ëˆˆ)ë¡œ ë³€í™˜
    rain_status = 0
    if req.pty and req.pty != "0" and req.pty != "ê°•ìˆ˜ì—†ìŒ":
        rain_status = 1

    # ì˜ˆì¸¡ ìˆ˜í–‰
    prediction = model.predict([[req.temp, rain_status]])
    result_text = prediction[0]

    # íŒŒì´ì¬ ì„œë²„ìž„ì„ í‹°ë‚´ê¸° ìœ„í•´ ì ‘ë‘ì–´ ì¶”ê°€
    return {"recommendation": f"[AI] {result_text}"}


# ================= AI ê¸°ìƒ ìºìŠ¤í„° (ë¸Œë¦¬í•‘ ìƒì„±) =================

class BriefingRequest(BaseModel):
    temp: str       # ê¸°ì˜¨
    sky: str        # í•˜ëŠ˜ìƒíƒœ
    pty: str        # ê°•ìˆ˜í˜•íƒœ
    pop: str        # ê°•ìˆ˜í™•ë¥ 
    pm10: str = "ì¢‹ìŒ" # ë¯¸ì„¸ë¨¼ì§€ (ê¸°ë³¸ê°’)

@app.post("/briefing")
def generate_briefing(req: BriefingRequest):
    # 1. LLM(OpenAI/Gemini) APIë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤.
    # prompt = f"í˜„ìž¬ ë‚ ì”¨ëŠ” ê¸°ì˜¨ {req.temp}ë„, í•˜ëŠ˜ì€ {req.sky}..."
    # response = openai.ChatCompletion.create(...)
    
    # 2. [í˜„ìž¬ êµ¬í˜„] ëžœë¤ í…œí”Œë¦¿ ì—”ì§„ (ë¹„ìš© ì—†ì´ LLM í‰ë‚´ë‚´ê¸°)
    
    # ê¸°ë³¸ ì¸ì‚¬ë§
    intro = random.choice([
        "ì•ˆë…•í•˜ì„¸ìš”! AI ê¸°ìƒìºìŠ¤í„°ìž…ë‹ˆë‹¤. ðŸŽ¤",
        "ë°˜ê°‘ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ì˜ ë‚ ì”¨ë¥¼ ì „í•´ë“œë¦´ê²Œìš”! ðŸŒˆ",
        "ì˜¤ëŠ˜ í•˜ë£¨ë„ íž˜ì°¨ê²Œ ì‹œìž‘í•´ë³¼ê¹Œìš”? ë‚ ì”¨ ë¸Œë¦¬í•‘ìž…ë‹ˆë‹¤. ðŸ“¢"
    ])

    # ë‚ ì”¨ ìƒíƒœ ë¬˜ì‚¬
    status_desc = ""
    if req.pty not in ["0", "ê°•ìˆ˜ì—†ìŒ", "ì •ë³´ ì—†ìŒ"]:
        status_desc = random.choice([
            f"í˜„ìž¬ ë°–ì—ëŠ” {req.pty}ê°€ ë‚´ë¦¬ê³  ìžˆì–´ìš”. ìš°ì‚° ê¼­ ì±™ê¸°ì…”ì•¼ê² ì–´ìš”! â˜”",
            f"ì•„ì´ê³ , {req.pty} ì†Œì‹ì´ ìžˆë„¤ìš”. ë¹—ê¸¸/ëˆˆê¸¸ ì¡°ì‹¬í•˜ì„¸ìš”! ðŸŒ§ï¸",
            f"ì§€ê¸ˆ {req.pty}ê°€ ì˜¤ê³  ìžˆìŠµë‹ˆë‹¤. ì‹¤ë‚´ í™œë™ì„ ì¶”ì²œë“œë ¤ìš”. ðŸ "
        ])
    elif req.sky == "ë§‘ìŒ":
        status_desc = random.choice([
            "í•˜ëŠ˜ì´ ì•„ì£¼ ë§‘ê³  ê¹¨ë—í•©ë‹ˆë‹¤! ì‚°ì±…í•˜ê¸° ë”± ì¢‹ì€ ë‚ ì”¨ì˜ˆìš”. â˜€ï¸",
            "íŒŒëž€ í•˜ëŠ˜ì´ ê¸°ë¶„ê¹Œì§€ ìƒì¾Œí•˜ê²Œ ë§Œë“¤ì–´ì£¼ë„¤ìš”. ì¬ê¸€ë¼ìŠ¤ëŠ” ì–´ë– ì„¸ìš”? ðŸ˜Ž",
            "í–‡ì‚´ì´ ê°€ë“í•œ í•˜ë£¨ìž…ë‹ˆë‹¤. ë¹„íƒ€ë¯¼D ì¶©ì „í•˜ì„¸ìš”! ðŸŒž"
        ])
    elif req.sky == "êµ¬ë¦„ë§ŽìŒ":
        status_desc = random.choice([
            "êµ¬ë¦„ì´ ì¡°ê¸ˆ ì§€ë‚˜ê°€ê³  ìžˆì–´ìš”. ë¥ì§€ë„ ì¶¥ì§€ë„ ì•Šì€ ë‚ ì”¨ë„¤ìš”. â˜ï¸",
            "í•˜ëŠ˜ì— êµ¬ë¦„ì´ ê·¸ë¦¼ì²˜ëŸ¼ ë–  ìžˆë„¤ìš”. ìš´ì¹˜ ìžˆëŠ” í•˜ë£¨ìž…ë‹ˆë‹¤. ðŸŒ¥ï¸"
        ])
    else: # íë¦¼
        status_desc = random.choice([
            "í•˜ëŠ˜ ë¹›ì´ ì¡°ê¸ˆ íë¦¬ë„¤ìš”. ê¸°ë¶„ë§Œì€ ë°ê²Œ ê°€ì ¸ê°€ì„¸ìš”! â˜ï¸",
            "êµ¬ë¦„ì´ ìž”ëœ© ê¼ˆì–´ìš”. í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ìž‘ì€ ìš°ì‚° í•˜ë‚˜ ì±™ê¸¸ê¹Œìš”? ðŸŒ‚"
        ])

    # ê¸°ì˜¨ ì½”ë©˜íŠ¸
    temp_val = float(req.temp)
    temp_desc = ""
    if temp_val > 28:
        temp_desc = "í‘¹í‘¹ ì°ŒëŠ” ë”ìœ„ìž…ë‹ˆë‹¤. ì‹œì›í•œ ë¬¼ ë§Žì´ ë“œì„¸ìš”! ðŸ§Š"
    elif temp_val > 20:
        temp_desc = "í™œë™í•˜ê¸° ì°¸ ì¢‹ì€ í¬ê·¼í•œ ê¸°ì˜¨ì´ì—ìš”. ðŸ˜Š"
    elif temp_val > 10:
        temp_desc = "ì•½ê°„ ìŒ€ìŒ€í•  ìˆ˜ ìžˆìœ¼ë‹ˆ ê²‰ì˜·ì„ ì±™ê¸°ì‹œë©´ ì¢‹ê² ì–´ìš”. ðŸ§¥"
    else:
        temp_desc = "ê³µê¸°ê°€ ë§Žì´ ì°¨ê°‘ìŠµë‹ˆë‹¤. ê°ê¸° ì¡°ì‹¬í•˜ì„¸ìš”! ðŸ§£"

    # ìµœì¢… ëŒ€ë³¸ ì¡°í•©
    full_script = f"{intro} {status_desc} í˜„ìž¬ ê¸°ì˜¨ì€ {req.temp}ë„ì´ë©°, ê°•ìˆ˜ í™•ë¥ ì€ {req.pop}%ìž…ë‹ˆë‹¤. {temp_desc}"
    
    return {"script": full_script}



# ================= AI ë‚ ì”¨ DJ =================

class DjRequest(BaseModel):
    pty: str  # ê°•ìˆ˜í˜•íƒœ
    sky: str  # í•˜ëŠ˜ìƒíƒœ
    hour: int # í˜„ìž¬ ì‹œê°„ (0~23)

@app.post("/dj")
def recommend_music(req: DjRequest):
    is_night = req.hour >= 19 or req.hour <= 6
    
    # 1. ì¶”ì²œ ë¡œì§ (ì¡°ê±´ì— ë”°ë¥¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ID ë§¤í•‘)
    # ìœ íŠœë¸Œ ì˜ìƒ ID (v= ë’¤ì— ìžˆëŠ” ì½”ë“œ)
    
    music_list = []
    
    # (1) ë¹„/ëˆˆ ì˜¬ ë•Œ
    if req.pty not in ["0", "ê°•ìˆ˜ì—†ìŒ", "ì •ë³´ ì—†ìŒ"]:
        music_list = [
            {"id": "O1jGOJOpxf8", "comment": "ë¹„ ì˜¤ëŠ” ë‚ ì—” ì°¨ë¶„í•œ Lo-fi ìž¬ì¦ˆê°€ ë”±ì´ì£ . â˜•"},
            {"id": "PTXcP6EvMB0", "comment": "ë¹—ì†Œë¦¬ì™€ í•¨ê»˜ ë“£ëŠ” ê°ì„±ì ì¸ íŒì†¡ ì–´ë– ì„¸ìš”? ðŸŒ§ï¸"},
            {"id": "YG0_Uo_GKh", "comment": "ì°½ë°–ì„ ë³´ë©° ë“£ê¸° ì¢‹ì€ ë¹„ ì˜¤ëŠ” ë‚ ì˜ í”¼ì•„ë…¸ ì—°ì£¼. ðŸŽ¹"}
        ]
    
    # (2) ë§‘ì€ ë‚ 
    elif req.sky == "ë§‘ìŒ":
        if is_night:
            # ë§‘ì€ ë°¤
            music_list = [
                {"id": "NSLjsCmlAVw", "comment": "ë°¤í•˜ëŠ˜ì˜ ë³„ì„ ë³´ë©° ë“£ëŠ” Chill-hop. ðŸŒ™"},
                {"id": "hGrIgIfCxP0", "comment": "íŽ¸ì•ˆí•œ ë°¤ì„ ìœ„í•œ Lofi Hip Hop Radio. ðŸŽ§"},
                {"id": "hiMoy4pyAl0", "comment": "ìƒˆë²½ ê°ì„±ì— ì–´ìš¸ë¦¬ëŠ” ìž”ìž”í•œ R&B. ðŸ·"}
            ]
        else:
            # ë§‘ì€ ë‚®
            music_list = [
                {"id": "DRdAgeHuL_g", "comment": "í–‡ì‚´ ì¢‹ì€ ë‚ ! ì‹ ë‚˜ëŠ” ë“œë¼ì´ë¸Œ ë®¤ì§ ì–´ë•Œìš”? ðŸš—"},
                {"id": "WKGiY3gBXTo", "comment": "ê¸°ë¶„ ì „í™˜ì„ ìœ„í•œ ìƒí¼í•œ K-Pop í”Œë ˆì´ë¦¬ìŠ¤íŠ¸! ðŸŽ¶"},
                {"id": "xZiruNde2Po", "comment": "ë§‘ì€ ì˜¤í›„ì— ì–´ìš¸ë¦¬ëŠ” ì–´ì¿ ìŠ¤í‹± ê¸°íƒ€ ì„ ìœ¨. ðŸŽ¸"}
            ]
            
    # (3) íë¦¼/êµ¬ë¦„ë§ŽìŒ
    else:
        music_list = [
            {"id": "3kZd1kHf8bU", "comment": "íë¦° ë‚ ì—” ì„¼ì¹˜í•œ ì¸ë”” ìŒì•…ì´ ì œê²©ì´ì£ . ðŸŒ«ï¸"},
            {"id": "DcgJucctt5Q", "comment": "ì¹´íŽ˜ì—ì„œ ë“£ê¸° ì¢‹ì€ ë¶€ë“œëŸ¬ìš´ ìž¬ì¦ˆ. ðŸŽ·"},
            {"id": "cqf0Ni3Jo_I", "comment": "êµ¬ë¦„ ë‚€ í•˜ëŠ˜ê³¼ ì–´ìš¸ë¦¬ëŠ” ëª½í™˜ì ì¸ íŒ. â˜ï¸"}
        ]

    # ëžœë¤ ì„ íƒ
    selected = random.choice(music_list)
    
    return {
        "videoId": selected["id"],
        "comment": f"[AI DJ] {selected['comment']}"
    }





# ì„œë²„ ì‹¤í–‰
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=5000)