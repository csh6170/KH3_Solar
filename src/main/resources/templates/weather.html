<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>종합 날씨 정보</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Dark Mode Config -->
    <script>
        tailwind.config = {
            darkMode: 'class', // 클래스 기반 다크모드 활성화
        }
    </script>
    <!-- Chart.js (그래프용) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome (아이콘) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-transition { transition: background-image 0.5s ease-in-out; }
        .sun-path {
            stroke-dasharray: 251.2; /* 2 * PI * R (40) roughly 251 */
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 2s ease-out;
        }
    </style>
</head>

<!-- 배경 이미지 동적 바인딩 & 배경 설정 -->
<body class="min-h-screen p-4 md:p-8 bg-cover bg-center bg-fixed bg-no-repeat bg-transition"
      th:style="'background-image: url(' + ${weather.bgImageUrl} + ');'">

<!-- 배경 오버레이 - 글자 가독성을 위해 필수 -->
<div class="fixed inset-0 bg-black/30 z-0 pointer-events-none"></div>

<!-- 메인 컨텐츠 래퍼 -->
<div class="max-w-5xl mx-auto relative z-10">

    <!-- 1. 상단 헤더 & 컨트롤 -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div class="text-center md:text-left flex-1">
            <!-- 로고 및 타이틀 -->
            <div class="inline-flex items-center justify-center md:justify-start gap-3 mb-1">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-blue-500 to-cyan-400 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fas fa-satellite-dish text-white text-2xl animate-pulse"></i>
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight drop-shadow-lg">
                        기상청 예보 <span class="text-cyan-300">대시보드</span>
                    </h1>
                </div>
            </div>
            <!-- Live Update 배지 -->
            <div class="mt-2 inline-flex items-center gap-2 bg-black/40 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/10 shadow-sm">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                </span>
                <p class="text-white/90 text-xs font-medium tracking-wide">
                    Live Update: <span class="font-bold text-white" th:text="${weather.baseDate} + ' ' + ${weather.baseTime}"></span>
                </p>
            </div>
        </div>

        <!-- 컨트롤 영역 (다크모드 토글 + 태양광 + 지역선택) -->
        <div class="flex flex-wrap justify-center md:justify-end gap-3 w-full md:w-auto items-center">
            <!-- 1-1. 태양광 예측 모달 트리거 버튼 -->
            <button onclick="openModal()"
                    class="bg-indigo-600 dark:bg-slate-800 hover:bg-indigo-700 dark:hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-indigo-500/30 transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 border border-indigo-400/30 backdrop-blur-sm">
                <i class="fas fa-solar-panel"></i>
                <span>태양광 예측</span>
            </button>

            <!-- 1-2. 태양광 예측 모달 (배경 다크모드 적용 안됨 - iframe 내부에서 처리) -->
            <div id="predictModal" class="fixed inset-0 z-50 hidden overflow-y-auto text-gray-800">
                <div class="flex items-center justify-center min-h-screen p-4 text-center">
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
                    <div class="relative bg-white dark:bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transform transition-all max-w-lg w-full z-50">
                        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 z-[60] bg-gray-100 dark:bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center transition">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                        <iframe src="/predict-form" class="w-full h-[900px] border-none bg-transparent" id="predictFrame"></iframe>
                    </div>
                </div>
            </div>

            <!-- 2-1. 위성 지도 버튼 (언어 버튼 대체) -->
            <button onclick="openMapModal()"
                    class="bg-blue-500 dark:bg-slate-800 hover:bg-blue-600 dark:hover:bg-slate-900 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 flex items-center gap-2 border border-blue-400/30 backdrop-blur-sm">
                <i class="fas fa-globe-asia"></i>
                <span>위성 지도</span>
            </button>

            <!-- 2-2. [위성 지도 모달 -->
            <div id="mapModal" class="fixed inset-0 z-50 hidden overflow-hidden text-gray-800">
                <div class="flex items-center justify-center min-h-screen p-4 text-center">
                    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeMapModal()"></div>
                    <div class="relative bg-white dark:bg-slate-900 rounded-3xl overflow-hidden shadow-2xl transform transition-all w-full max-w-5xl h-[80vh] z-50 flex flex-col">

                        <!-- 모달 헤더 -->
                        <div class="bg-slate-800 text-white px-6 py-4 flex justify-between items-center shrink-0">
                            <h3 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-globe-asia text-blue-400"></i> 실시간 위성/레이더 영상</h3>
                            <button onclick="closeMapModal()" class="text-gray-400 hover:text-white transition">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <!-- Windy Embed Iframe -->
                        <iframe src="https://embed.windy.com/embed2.html?lat=36.5&lon=127.5&detailLat=37.5&detailLon=127.0&width=650&height=450&zoom=6&level=surface&overlay=rain&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1"
                                class="w-full h-full border-none"
                                id="windyFrame">
                        </iframe>
                    </div>
                </div>
            </div>

            <!-- 3. 지역 선택 드롭다운 -->
            <div class="relative w-full sm:w-64 group">
                <select onchange="const c=this.value.split(','); location.href='/?nx='+c[0]+'&ny='+c[1]"
                        class="w-full p-3 pl-4 pr-10 rounded-xl border border-white/20 bg-white/10 backdrop-blur-md text-white font-bold shadow-lg focus:ring-2 focus:ring-cyan-400 focus:bg-white/20 outline-none cursor-pointer transition appearance-none hover:bg-white/20 dark:bg-black/40">
                    <option class="text-gray-800" th:each="region : ${regions}"
                            th:value="${region.nx} + ',' + ${region.ny}"
                            th:text="${region.name}"
                            th:selected="${region.nx == currentNx && region.ny == currentNy}">지역</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-white/70 group-hover:text-white transition">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
            </div>

            <!-- 4. 다크모드 토글 버튼 -->
            <button onclick="toggleDarkMode()"
                    class="bg-white/20 hover:bg-white/30 text-white w-12 h-12 rounded-xl backdrop-blur-md border border-white/20 shadow-lg flex items-center justify-center transition-transform active:scale-95 group">
                <i id="darkModeIcon" class="fas fa-sun text-xl group-hover:rotate-45 transition-transform duration-500"></i>
            </button>
        </div>
    </div>

    <!-- 2. 메인 날씨 카드 -->
    <a href="https://www.kma.go.kr/w/iframe/dfs.do" target="_blank" class="block hover-card">
        <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-md rounded-3xl p-8 shadow-2xl mb-6 flex flex-col md:flex-row items-center justify-between border border-white/50 dark:border-slate-700 transition-colors duration-300">
            <div class="text-center md:text-left">
                <h2 class="text-2xl font-bold mb-2 text-gray-700 dark:text-gray-200 flex items-center justify-center md:justify-start gap-2">
                    <i class="fas fa-location-dot text-blue-500"></i>
                    <span th:text="${currentRegionName}">지역명</span>
                </h2>
                <!-- 현재 온도 -->
                <div class="text-7xl font-extrabold mb-2 text-gray-900 dark:text-white tracking-tight">
                    <span th:text="${weather.TMP}">-</span><span class="text-4xl align-top">°</span>
                </div>
                <!-- 날씨 상태 및 최저/최고 기온 -->
                <p class="text-xl font-medium text-gray-600 dark:text-gray-400">
                    <span th:text="${weather.SKY}">-</span>
                    <span th:if="${weather.PTY != '강수없음'}" th:text="'/ ' + ${weather.PTY}"></span>
                </p>
                <!-- 최저/최고/체감 온도 -->
                <div class="mt-6 flex gap-4 text-sm bg-gray-100/80 dark:bg-slate-800/80 p-3 rounded-xl inline-flex shadow-inner dark:shadow-none dark:border dark:border-slate-700">
                    <span class="flex items-center gap-1 dark:text-white"><i class="fas fa-temperature-low text-blue-500"></i> 최저 <span th:text="${weather.TMN != null ? weather.TMN : '-'}"></span>°</span>
                    <span class="w-px h-4 bg-gray-300 dark:bg-gray-600"></span>
                    <span class="flex items-center gap-1 dark:text-white"><i class="fas fa-temperature-high text-red-500"></i> 최고 <span th:text="${weather.TMX != null ? weather.TMX : '-'}"></span>°</span>
                    <span class="w-px h-4 bg-gray-300 dark:bg-gray-600"></span>
                    <span class="flex items-center gap-1 dark:text-white"><i class="fas fa-user-check text-indigo-500"></i> 체감 <span th:text="${weather.sensibleTemp != null ? weather.sensibleTemp : '-'}"></span>°</span>
                </div>
            </div>

            <!-- 날씨 아이콘 -->
            <div class="mt-8 md:mt-0 transform">
                <i th:if="${weather.PTY == '비'}" class="fas fa-cloud-showers-heavy text-9xl text-blue-500 animate-bounce drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '눈'}" class="fas fa-snowflake text-9xl text-sky-300 animate-spin-slow drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '비/눈'}" class="fas fa-cloud-meatball text-9xl text-gray-400 animate-pulse drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '소나기'}" class="fas fa-cloud-showers-water text-9xl text-blue-600 animate-bounce drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '빗방울'}" class="fas fa-cloud-rain text-9xl text-blue-400 animate-pulse drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '강수없음' && weather.SKY == '맑음'}" class="fas fa-sun text-9xl text-yellow-400 animate-pulse drop-shadow-[0_0_15px_rgba(250,204,21,0.6)]"></i>
                <i th:if="${weather.PTY == '강수없음' && weather.SKY == '구름많음'}" class="fas fa-cloud-sun text-9xl text-gray-400 drop-shadow-xl"></i>
                <i th:if="${weather.PTY == '강수없음' && weather.SKY == '흐림'}" class="fas fa-cloud text-9xl text-gray-500 drop-shadow-xl"></i>
            </div>
        </div>
    </a>

    <!-- 3. AI 라이프스타일 매니저 -->
    <div class="bg-white/95 dark:bg-slate-900/90 backdrop-blur-md rounded-3xl shadow-xl overflow-hidden mb-8 border border-white/50 dark:border-slate-700 transition-all duration-300">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between cursor-pointer" onclick="toggleAiManager()">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-xl shadow-inner">
                    🤖
                </div>
                <h3 class="text-lg font-bold text-white tracking-wide">AI 라이프스타일 매니저</h3>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="speakBriefing(); event.stopPropagation();" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full text-sm font-bold transition active:scale-95 backdrop-blur-sm border border-white/10">
                    <i class="fas fa-volume-up"></i> <span class="hidden sm:inline">브리핑 듣기</span>
                </button>
                <button class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 text-white transition backdrop-blur-sm border border-white/10">
                    <i id="aiToggleIcon" class="fas fa-chevron-up transition-transform duration-500"></i>
                </button>
            </div>
        </div>

        <!-- 3. AI 매니저 컨텐츠 영역 -->
        <div id="aiManagerContent" class="transition-all duration-500 ease-in-out max-h-[1000px] opacity-100 overflow-hidden">
            <div class="flex flex-col md:flex-row">
                <!-- (왼쪽)캐스터 카드 -->
                <div class="flex-1 p-6 md:p-8 border-b md:border-b-0 md:border-r border-gray-100 dark:border-slate-700 bg-indigo-50/30 dark:bg-slate-800/30">
                    <div class="flex gap-4 items-start">
                        <div class="flex-shrink-0 text-center">
                            <div class="w-16 h-16 rounded-full bg-white dark:bg-slate-700 border-2 border-indigo-200 dark:border-slate-600 flex items-center justify-center text-3xl shadow-sm mb-2">👩‍💼</div>
                            <span class="text-[10px] font-bold text-indigo-500 dark:text-indigo-300 uppercase tracking-wider bg-indigo-100 dark:bg-indigo-900/50 px-2 py-0.5 rounded-full">Caster</span>
                        </div>
                        <!-- 오늘의 날씨 브리핑 -->
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-indigo-800 dark:text-indigo-300 mb-2 flex items-center gap-2"><i class="fas fa-microphone-alt"></i> 오늘의 날씨 브리핑</h4>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl rounded-tl-none border border-indigo-100 dark:border-slate-600 shadow-sm relative">
                                <p id="aiBriefingText" class="text-gray-700 dark:text-gray-300 leading-relaxed font-medium text-sm md:text-base" th:utext="${weather.aiBriefing}">캐스터가 대본을 준비중입니다...</p>
                                <div class="absolute top-0 -left-2 w-4 h-4 bg-white dark:bg-slate-800 border-t border-l border-indigo-100 dark:border-slate-600 transform -rotate-45"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- (오른쪽)스타일리스트 카드 -->
                <div class="flex-1 p-6 md:p-8 bg-purple-50/30 dark:bg-slate-800/30">
                    <div class="flex gap-4 items-start">
                        <div class="flex-shrink-0 text-center">
                            <div class="w-16 h-16 rounded-full bg-white dark:bg-slate-700 border-2 border-purple-200 dark:border-slate-600 flex items-center justify-center text-3xl shadow-sm mb-2">👗</div>
                            <span class="text-[10px] font-bold text-purple-500 dark:text-purple-300 uppercase tracking-wider bg-purple-100 dark:bg-purple-900/50 px-2 py-0.5 rounded-full">Stylist</span>
                        </div>
                        <!-- 오늘의 옷차림 추천 -->
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-purple-800 dark:text-purple-300 mb-2 flex items-center gap-2"><i class="fas fa-tshirt"></i> 오늘의 옷차림 추천</h4>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl rounded-tl-none border border-purple-100 dark:border-slate-600 shadow-sm relative flex flex-col gap-2">
                                <div class="flex items-center gap-3 mb-1">
                                    <div class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center text-purple-600 dark:text-purple-300"><i th:class="${weather.outfitIcon}"></i></div>
                                    <span class="font-bold text-gray-800 dark:text-gray-200">Today's Pick!</span>
                                </div>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed font-medium text-sm md:text-base"><span th:utext="${weather.clothingRecommendation}"></span></p>
                                <div class="absolute top-0 -left-2 w-4 h-4 bg-white dark:bg-slate-800 border-t border-l border-purple-100 dark:border-slate-600 transform -rotate-45"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. 향후 6시간 상세 예보 -->
    <div class="mb-8">
        <h3 class="text-xl font-bold text-white mb-4 px-1 flex items-center drop-shadow-md">
            <i class="fas fa-history text-blue-300 mr-2"></i>향후 6시간 예보
        </h3>
        <!-- 가로 스크롤 카드 리스트 -->
        <div class="flex overflow-x-auto space-x-4 pb-4 scrollbar-hide">
            <div th:each="item : ${weather.shortTermForecasts}"
                 class="min-w-[140px] bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm p-4 rounded-2xl shadow-lg border border-white/40 dark:border-slate-700 flex flex-col items-center justify-between hover:scale-105 transition duration-300">
                <span class="text-gray-500 dark:text-gray-400 font-bold text-sm bg-gray-100 dark:bg-slate-800 px-3 py-1 rounded-full mb-2"><span th:text="${#strings.substring(item.fcstTime, 0, 2)}">12</span>:00</span>
                <div class="text-4xl my-2 text-gray-600 dark:text-gray-300">
                    <i th:if="${item.PTY != '0'}" class="fas fa-umbrella text-blue-400 drop-shadow-sm"></i>
                    <i th:if="${item.PTY == '0' && item.SKY == '1'}" class="fas fa-sun text-yellow-400 drop-shadow-sm"></i>
                    <i th:if="${item.PTY == '0' && item.SKY == '3'}" class="fas fa-cloud-sun text-gray-400 drop-shadow-sm"></i>
                    <i th:if="${item.PTY == '0' && item.SKY == '4'}" class="fas fa-cloud text-gray-500 drop-shadow-sm"></i>
                </div>
                <div class="text-2xl font-bold text-gray-800 dark:text-white mb-1"><span th:text="${item.T1H}"></span>°</div>
                <div th:if="${item.LGT != '0' && item.LGT != '-100' && item.LGT != null}" class="text-xs font-bold text-red-500 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded flex items-center gap-1 mb-1 animate-pulse"><i class="fas fa-bolt"></i> 낙뢰주의</div>
                <div class="text-xs text-gray-400 dark:text-gray-500 text-center w-full border-t border-gray-200 dark:border-slate-700 pt-2 mt-2 space-y-1">
                    <div class="flex justify-between w-full"><span><i class="fas fa-tint text-blue-300"></i></span><span th:text="${item.REH} + '%'"></span></div>
                    <div class="flex justify-between w-full"><span><i class="fas fa-wind text-gray-300"></i></span><span th:text="${item.WSD} + 'm/s'"></span></div>
                </div>
            </div>
        </div>
        <div class="bg-white/95 dark:bg-slate-900/80 backdrop-blur-md p-6 rounded-3xl shadow-lg border border-white/50 dark:border-slate-700 mt-6">
            <h4 class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-4 flex items-center"><i class="fas fa-chart-line mr-2 text-blue-500"></i>기온 및 습도 변화 추이</h4>
            <div class="relative h-64 w-full"><canvas id="weatherChart"></canvas></div>
        </div>
    </div>

    <!-- 5. 태양 & 달의 이동 경로 -->
    <div class="mb-10">
        <h3 class="text-xl font-bold text-white mb-4 px-1 flex items-center drop-shadow-md">
            <i class="fas" th:classappend="${weather.dayTime ? 'fa-sun text-yellow-300' : 'fa-moon text-blue-200'}"></i>
            <span class="ml-2" th:text="${weather.dayTime ? '태양의 이동' : '달의 이동'}">태양의 이동</span>
        </h3>
        <div class="bg-gradient-to-br p-8 rounded-3xl shadow-2xl relative overflow-hidden text-center border border-white/10"
             th:classappend="${weather.dayTime ? 'from-indigo-900 to-slate-800' : 'from-slate-900 to-black'}">
            <!-- 별 배경 효과 -->
            <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: radial-gradient(white 1px, transparent 1px); background-size: 20px 20px;"></div>

            <!-- 태양/달 경로 그래픽 -->
            <div class="relative z-10 flex flex-col items-center">
                <div class="w-full max-w-sm relative h-40 mb-2">
                    <svg viewBox="0 0 100 50" class="w-full h-full overflow-visible">
                        <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="2" stroke-linecap="round" stroke-dasharray="4 4" />
                        <path id="sunProgressPath" d="M 10 50 A 40 40 0 0 1 90 50" fill="none"
                              th:attr="stroke=${weather.dayTime ? 'url(#sunGradient)' : 'url(#moonGradient)'}"
                              stroke-width="4" stroke-linecap="round" class="sun-path" />
                        <defs>
                            <linearGradient id="sunGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FDB813;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="moonGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#E2E8F0;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#94A3B8;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <g id="sunIconGroup">
                            <circle cx="0" cy="0" r="3"
                                    th:attr="fill=${weather.dayTime ? '#FDB813' : '#E2E8F0'}, filter=${weather.dayTime ? 'drop-shadow(0 0 4px #FDB813)' : 'drop-shadow(0 0 4px #E2E8F0)'}" />
                            <text x="0" y="-6" text-anchor="middle" fill="white" font-size="3" font-weight="bold" id="sunTimeText">Now</text>
                        </g>
                    </svg>
                    <div class="absolute bottom-0 left-0 w-full h-px bg-white/20"></div>
                </div>

                <!-- 일출/일몰 정보 -->
                <div class="flex justify-between w-full max-w-sm px-2 text-white/90 text-sm font-medium">
                    <div class="text-left">
                        <p class="text-xs text-white/50 uppercase tracking-wider" th:text="${weather.dayTime ? 'Sunrise' : 'Moonrise'}">Sunrise</p>
                        <p class="text-lg font-bold text-yellow-300">
                            <i class="fas" th:classappend="${weather.dayTime ? 'fa-sun' : 'fa-moon'}"></i>
                            <span th:text="${weather.dayTime ? weather.sunrise : weather.sunset}">06:00</span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-white/50 uppercase tracking-wider" th:text="${weather.dayTime ? 'Sunset' : 'Moonset'}">Sunset</p>
                        <p class="text-lg font-bold text-orange-400">
                            <span th:text="${weather.dayTime ? weather.sunset : weather.sunrise}">19:00</span>
                            <i class="fas" th:classappend="${weather.dayTime ? 'fa-moon' : 'fa-sun'}"></i>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. AI 날씨 DJ 카드 -->
    <div class="bg-black/80 dark:bg-black/90 backdrop-blur-md rounded-3xl p-6 shadow-2xl border border-gray-700 mb-10 text-white flex flex-col md:flex-row gap-6">
        <!-- 유튜브 임베드 -->
        <div class="w-full md:w-1/3 aspect-video md:aspect-square rounded-2xl overflow-hidden shadow-lg border border-gray-600 bg-black relative group">
            <iframe th:src="'https://www.youtube.com/embed/' + ${weather.youtubeVideoId} + '?autoplay=0&controls=1&showinfo=0&rel=0'"
                    title="YouTube video player" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    class="absolute inset-0 w-full h-full"></iframe>
        </div>
        <!-- 설명 및 코멘트 -->
        <div class="flex-1 flex flex-col justify-center">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-xs font-bold text-black bg-green-400 px-2 py-1 rounded-full uppercase tracking-wider">Now Playing</span>
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest"><i class="fas fa-headphones-alt mr-1"></i> AI Weather DJ</h3>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-white">날씨에 딱 맞는 선곡 🎵</h2>
            <div class="bg-white/10 p-5 rounded-2xl backdrop-blur-sm border border-white/10">
                <p class="text-lg font-light leading-relaxed text-gray-200">
                    "<span th:text="${weather.musicComment}">음악을 고르는 중입니다...</span>"
                </p>
            </div>
            <div class="mt-4 flex gap-4 text-sm text-gray-500">
                <span class="flex items-center gap-1"><i class="fas fa-cloud"></i> 날씨 기반 추천</span>
                <span class="flex items-center gap-1"><i class="fas fa-clock"></i> 시간대 반영</span>
            </div>
        </div>
    </div>

    <!-- 7. 오늘 상세 데이터 -->
    <div class="mb-10">
        <h3 class="text-xl font-bold text-white mb-4 px-1 flex items-center drop-shadow-md">
            <i class="fas fa-chart-bar text-teal-300 mr-2"></i>오늘 상세 날씨
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border dark:border-slate-700 hover:shadow-md transition">
                <p class="text-xs text-gray-400 font-bold mb-1">강수확률</p>
                <div class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-umbrella text-blue-400 mr-2"></i><span th:text="${weather.POP}">-</span>%</div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border dark:border-slate-700 hover:shadow-md transition">
                <p class="text-xs text-gray-400 font-bold mb-1">습도</p>
                <div class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-tint text-indigo-400 mr-2"></i><span th:text="${weather.REH}">-</span>%</div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border dark:border-slate-700 hover:shadow-md transition">
                <p class="text-xs text-gray-400 font-bold mb-1">풍속</p>
                <div class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-wind text-gray-400 mr-2"></i><span th:text="${weather.WSD}">-</span>m/s</div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border dark:border-slate-700 hover:shadow-md transition">
                <p class="text-xs text-gray-400 font-bold mb-1">파고</p>
                <div class="text-2xl font-bold text-gray-800 dark:text-white"><i class="fas fa-water text-blue-600 mr-2"></i><span th:text="${weather.WAV}">-</span>M</div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">1시간 강수량</p>
                <div class="text-lg font-bold text-slate-700 dark:text-slate-300"><span th:text="${weather.PCP}">-</span></div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">1시간 적설</p>
                <div class="text-lg font-bold text-slate-700 dark:text-slate-300"><span th:text="${weather.SNO}">-</span></div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">동서바람</p>
                <div class="text-lg font-bold text-slate-700 dark:text-slate-300"><span th:text="${weather.UUU}">-</span> m/s</div>
            </div>
            <div class="bg-white dark:bg-slate-900/80 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">남북바람</p>
                <div class="text-lg font-bold text-slate-700 dark:text-slate-300"><span th:text="${weather.VVV}">-</span> m/s</div>
            </div>
        </div>
    </div>

    <!-- 8. 생활 기상 지수 -->
    <div class="mb-10">
        <h3 class="text-xl font-bold text-white mb-4 px-1 flex items-center drop-shadow-md">
            <i class="fas fa-heart text-pink-300 mr-2"></i>생활 및 대기 정보
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 8-1. 자외선 카드 -->
            <a href="https://www.weather.go.kr/w/theme/daily-life/life-index.do" target="_blank" class="block hover-card">
                <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-orange-100/50 dark:border-slate-700 flex items-center justify-between hover:shadow-lg transition cursor-pointer h-full">
                    <div>
                        <div class="text-sm font-bold text-orange-500 mb-1 flex items-center gap-1"><i class="fas fa-sun"></i> 자외선 지수 <i class="fas fa-external-link-alt text-xs ml-1 opacity-50"></i></div>
                        <div class="text-3xl font-bold text-gray-800 dark:text-white mb-2"><span th:text="${weather.uvStage}">-</span><span class="text-lg text-gray-400 dark:text-gray-500 font-normal" th:text="'(' + ${weather.uvIndex} + ')'"></span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 leading-tight" th:text="${weather.uvComment}">정보 로딩중...</p>
                    </div>
                    <div class="text-5xl text-orange-200 opacity-50"><i class="fas fa-umbrella-beach"></i></div>
                </div>
            </a>

            <!-- 8-2. 미세먼지 카드 -->
            <a href="https://www.airkorea.or.kr/" target="_blank" class="block hover-card">
                <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-gray-100/50 dark:border-slate-700 flex items-center justify-between hover:shadow-lg transition cursor-pointer h-full">
                    <div>
                        <div class="text-sm font-bold text-gray-600 dark:text-gray-400 mb-1 flex items-center gap-1"><i class="fas fa-smog"></i> 미세먼지(PM10) <i class="fas fa-external-link-alt text-xs ml-1 opacity-50"></i></div>
                        <div class="text-3xl font-bold text-gray-800 dark:text-white mb-2"><span th:text="${weather.getGradeText(weather.pm10Grade)}">-</span><span class="text-lg text-gray-400 dark:text-gray-500 font-normal" th:text="'(' + ${weather.pm10Value} + '㎍/㎥)'"></span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 leading-tight" th:text="${weather.dustComment}">대기 정보 수신 중...</p>
                    </div>
                    <div class="text-5xl opacity-50" th:classappend="${weather.pm10Grade == '1' ? 'text-blue-200' : (weather.pm10Grade == '2' ? 'text-green-200' : (weather.pm10Grade == '3' ? 'text-yellow-200' : 'text-red-200'))}"><i class="fas fa-mask"></i></div>
                </div>
            </a>

            <!-- 8-3.불쾌지수 카드 -->
            <a href="https://search.naver.com/search.naver?where=nexearch&sm=top_hty&fbm=0&ie=utf8&query=%EB%B6%88%EC%BE%8C%EC%A7%80%EC%88%98" target="_blank" class="block hover-card">
                <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-red-100/50 dark:border-slate-700 flex items-center justify-between hover:shadow-lg transition cursor-pointer h-full">
                    <div>
                        <div class="text-sm font-bold text-red-500 mb-1 flex items-center gap-1"><i class="fas fa-tired"></i> 불쾌지수 <i class="fas fa-external-link-alt text-xs ml-1 opacity-50"></i></div>
                        <div class="text-3xl font-bold text-gray-800 dark:text-white mb-2"><span th:text="${weather.discomfortStage}">-</span><span class="text-lg text-gray-400 dark:text-gray-500 font-normal" th:text="'(' + ${weather.discomfortIndex} + ')'"></span></div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 leading-tight" th:text="${weather.discomfortComment}">계산 중...</p>
                    </div>
                    <div class="text-5xl text-red-200 opacity-50"><i class="fas fa-temperature-arrow-up"></i></div>
                </div>
            </a>

            <!-- 8-4.꽃가루 농도 위험지수 카드 -->
            <a href="http://www.nims.go.kr/?sub_num=1033" target="_blank" class="block hover-card">
                <div class="bg-white/90 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl p-6 shadow-md border border-green-100/50 flex items-center justify-between hover:shadow-lg transition">
                    <div>
                        <div class="text-sm font-bold text-green-600 mb-1 flex items-center gap-1"><i class="fas fa-tree"></i> 꽃가루 농도</div>

                        <!-- 계절에 따라 표시되는 정보가 다름 -->
                        <div class="text-3xl font-bold text-gray-800 mb-2" th:if="${weather.oakPollenRisk != null}">
                            <span th:text="${weather.getPollenRiskText(weather.oakPollenRisk)}"></span>
                            <span class="text-xs font-normal text-gray-400 dark:text-white block mt-1">(참나무 기준)</span>
                        </div>
                        <div class="text-3xl font-bold text-gray-800 mb-2" th:if="${weather.weedsPollenRisk != null}">
                            <span th:text="${weather.getPollenRiskText(weather.weedsPollenRisk)}"></span>
                            <span class="text-xs font-normal text-gray-400 dark:text-white block mt-1">(잡초류 기준)</span>
                        </div>
                        <div class="text-xl font-bold text-gray-400 dark:text-white mb-2" th:if="${weather.oakPollenRisk == null && weather.weedsPollenRisk == null}">
                            제공기간 아님
                        </div>

                        <p class="text-sm text-gray-500 dark:text-gray-400 leading-tight" th:text="${weather.pollenComment}">데이터 확인 중...</p>
                    </div>
                    <div class="text-5xl text-green-200 opacity-50"><i class="fas fa-seedling"></i></div>
                </div>
            </a>


        </div>
    </div>

    <!-- 9. 재난 안전 상황실 -->
    <div class="mb-10">
        <h3 class="text-xl font-bold text-white mb-4 px-1 flex items-center drop-shadow-md"><i class="fas fa-bullhorn text-red-400 mr-2 animate-pulse"></i>재난 상황실</h3>
        <div class="grid grid-cols-1 gap-4">
            <!-- 기상특보: 경고 발생 (위험시) -->
            <div th:if="${weather.hasWarning}" class="bg-red-50/95 dark:bg-red-900/60 backdrop-blur-sm border-l-8 border-red-500 p-6 rounded-r-2xl shadow-md flex items-start gap-5 animate-pulse">
                <div class="text-4xl text-red-500 dark:text-red-400 mt-1"><i class="fas fa-exclamation-triangle"></i></div>
                <div><h4 class="text-xl font-bold text-red-700 dark:text-red-200 mb-2">기상특보 발효 중</h4><p class="text-red-600 dark:text-red-300 whitespace-pre-line leading-relaxed font-medium" th:text="${weather.warningMsg}"></p></div>
            </div>
            <!-- 기상특보: 없음 (안전) -->
            <div th:unless="${weather.hasWarning}" class="bg-green-50/90 dark:bg-green-900/60 backdrop-blur-sm border-l-8 border-green-500 p-6 rounded-r-2xl shadow-md flex items-center gap-5">
                <div class="text-4xl text-green-500 dark:text-green-400"><i class="fas fa-check-circle"></i></div>
                <div><h4 class="text-xl font-bold text-green-700 dark:text-green-200 mb-1">기상특보 없음</h4><p class="text-green-600 dark:text-green-300 font-medium">현재 발효 중인 기상특보가 없습니다. 평온한 날씨입니다.</p></div>
            </div>

            <!-- 지진: 발생 (위험시) -->
            <div th:if="${weather.hasEarthquake}" class="bg-yellow-50/95 dark:bg-yellow-900/60 backdrop-blur-sm border-l-8 border-yellow-500 p-6 rounded-r-2xl shadow-md flex items-start gap-5">
                <div class="text-4xl text-yellow-600 dark:text-yellow-400 mt-1"><i class="fas fa-rss"></i></div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2"><h4 class="text-xl font-bold text-yellow-800 dark:text-yellow-200">최근 지진 정보 (거리: <span th:text="${weather.eqDist}"></span>)</h4><span class="text-sm text-yellow-700 dark:text-yellow-300 font-bold bg-yellow-200/50 dark:bg-yellow-800/50 px-2 py-1 rounded" th:text="${weather.eqTime}"></span></div>
                    <p class="text-yellow-800 dark:text-yellow-100 font-medium text-lg flex items-center gap-2"><span class="bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 px-2 py-0.5 rounded text-sm font-bold">규모</span><span class="font-extrabold text-2xl" th:text="${weather.eqMag}"></span><span class="text-gray-400 mx-1">|</span><span th:text="${weather.eqLoc}"></span></p>
                    <div class="bg-white/50 dark:bg-black/30 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700/50 mb-3"><p class="text-sm font-bold text-yellow-900 dark:text-yellow-200 flex items-center"><i class="fas fa-robot mr-2"></i>AI 안전 분석:<span class="font-normal ml-1" th:text="${weather.eqSafetyMsg}"></span></p></div>
                    <a href="/earthquake" class="text-sm text-yellow-700 hover:text-yellow-900 dark:text-yellow-300 dark:hover:text-yellow-100 font-bold underline mt-3 inline-block transition">자세히 보기 <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
            </div>

            <!-- 태풍: 발생 (위험시) -->
            <div th:if="${weather.hasTyphoon}" class="bg-blue-50/95 dark:bg-blue-900/60 backdrop-blur-sm border-l-8 border-blue-500 p-6 rounded-r-2xl shadow-md flex items-start gap-5">
                <div class="text-4xl text-blue-600 dark:text-blue-400 mt-1"><i class="fas fa-hurricane animate-spin-slow"></i></div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-2"><h4 class="text-xl font-bold text-blue-800 dark:text-blue-200">태풍 활동 중 (거리: <span th:text="${weather.typhoonDist}"></span>)</h4><span class="text-sm text-blue-700 dark:text-blue-300 font-bold bg-blue-200/50 dark:bg-blue-800/50 px-2 py-1 rounded" th:text="${weather.typhoonTime}"></span></div>
                    <p class="text-blue-800 dark:text-blue-100 font-medium text-lg"><span class="font-extrabold text-2xl" th:text="${weather.typhoonName}"></span></p>
                    <p class="text-blue-600 dark:text-blue-300 text-sm mt-1 mb-2 font-medium" th:text="${weather.typhoonStatus}">현재 진행 중</p>
                    <div class="bg-white/50 dark:bg-black/30 p-3 rounded-lg border border-blue-200 dark:border-blue-700/50 mb-3"><p class="text-sm font-bold text-blue-900 dark:text-blue-200 flex items-center"><i class="fas fa-robot mr-2"></i>AI 안전 분석:<span class="font-normal ml-1" th:text="${weather.typhoonSafetyMsg}"></span></p></div>
                    <a href="/typhoon" class="text-sm text-blue-700 hover:text-blue-900 dark:text-blue-300 dark:hover:text-blue-100 font-bold underline inline-block transition">경로 확인하기 <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
            </div>

            <!-- 안전할 때 표시 -->
            <div th:if="${!weather.hasWarning && !weather.hasTyphoon && !weather.hasEarthquake}" class="bg-green-50/90 dark:bg-green-900/60 backdrop-blur-sm border-l-8 border-green-500 p-6 rounded-r-2xl shadow-md flex items-start gap-5">
                <div class="text-4xl text-green-500 dark:text-green-400"><i class="fas fa-shield-check"></i></div>
                <div class="flex-1">
                    <h4 class="text-xl font-bold text-green-700 dark:text-green-200 mb-1">재난 안전 상태 '양호'</h4>
                    <p class="text-green-600 dark:text-green-300 font-medium mb-4">현재 사용자 위치 주변에 주요 위험 요소가 없습니다.</p>

                    <!-- 지난 기록 바로가기 버튼 추가 -->
                    <div class="flex flex-wrap gap-3">
                        <a href="/earthquake" class="inline-flex items-center text-sm font-bold text-green-700 dark:text-green-200 bg-white/60 dark:bg-green-800/40 px-4 py-2 rounded-lg hover:bg-white dark:hover:bg-green-800/60 transition shadow-sm border border-green-200/50 dark:border-green-700/50">
                            <i class="fas fa-rss mr-2"></i>지난 지진 기록
                        </a>
                        <a href="/typhoon" class="inline-flex items-center text-sm font-bold text-green-700 dark:text-green-200 bg-white/60 dark:bg-green-800/40 px-4 py-2 rounded-lg hover:bg-white dark:hover:bg-green-800/60 transition shadow-sm border border-green-200/50 dark:border-green-700/50">
                            <i class="fas fa-wind mr-2"></i>지난 태풍 기록
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 하단 새로고침 버튼 -->
    <button onclick="location.reload()" class="w-full bg-white/20 hover:bg-white/30 dark:bg-slate-800/40 dark:hover:bg-slate-700/50 backdrop-blur-md text-white font-bold py-4 rounded-xl shadow-lg transition border border-white/50 dark:border-white/10 active:scale-[0.98] duration-200">
        <i class="fas fa-sync-alt mr-2 animate-spin-slow-on-hover"></i> 전체 데이터 새로고침
    </button>

    <!-- 푸터 -->
    <div class="mt-8 pb-8 text-center text-white/60 text-xs font-light">
        <p class="mb-1">데이터 출처: 공공데이터포털 (기상청 API, 에어코리아)</p>
        <p>AI Analysis Powered by Python & Scikit-learn</p>
    </div>

    <!-- 맨 위로 가기 버튼 -->
    <button id="backToTopBtn" onclick="scrollToTop()"
            class="fixed bottom-8 right-8 z-50 bg-indigo-600 hover:bg-indigo-700 text-white w-12 h-12 rounded-full shadow-xl flex items-center justify-center cursor-pointer transition-all duration-300 opacity-0 translate-y-10 pointer-events-none hover:-translate-y-1">
        <i class="fas fa-arrow-up"></i>
    </button>

</div>

<!-- [스크립트] Chart.js 그래프 생성 로직 -->
<script th:inline="javascript">
    // 1. 다크모드 관리 (자동 + 수동)
    // 서버에서 넘어온 시간 정보 (true: 낮, false: 밤)
    /*[# th:if="${weather.dayTime != null}"]*/
    const isDayTimeServer = /*[[${weather.dayTime}]]*/ true;
    /*[/]*/
    /*[# th:unless="${weather.dayTime != null}"]*/
    const isDayTimeServer = true;
    /*[/]*/

    function initDarkMode() {
        const html = document.documentElement;
        const icon = document.getElementById('darkModeIcon');

        // 1순위: 사용자가 수동으로 설정한 값 (localStorage)
        // 2순위: 서버에서 알려준 낮/밤 시간 (isDayTimeServer)
        const savedTheme = localStorage.getItem('theme');

        let isDark = false;

        if (savedTheme === 'dark') {
            isDark = true;
        } else if (savedTheme === 'light') {
            isDark = false;
        } else {
            // 저장된 값이 없으면 서버 시간 기준 (밤이면 다크모드)
            isDark = !isDayTimeServer;
        }

        if (isDark) {
            html.classList.add('dark');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        } else {
            html.classList.remove('dark');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        }
        syncIframeTheme(); // iframe 테마 동기화 호출
    }

    function toggleDarkMode() {
        const html = document.documentElement;
        const icon = document.getElementById('darkModeIcon');

        if (html.classList.contains('dark')) {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
        syncIframeTheme(); // 토글 시 iframe 테마 동기화 호출
    }

    // iframe 내부 테마 동기화 함수
    function syncIframeTheme() {
        const iframe = document.getElementById('predictFrame');
        if (iframe && iframe.contentDocument) {
            const isDark = document.documentElement.classList.contains('dark');
            const iframeHtml = iframe.contentDocument.documentElement;

            if (isDark) {
                iframeHtml.classList.add('dark');
            } else {
                iframeHtml.classList.remove('dark');
            }
        }
    }

    // 페이지 로드 시 테마 초기화
    initDarkMode();

    // iframe이 로드될 때마다 테마 동기화 (페이지 이동 등)
    document.getElementById('predictFrame').onload = function() {
        syncIframeTheme();
    };


    // 위성 지도 모달 기능
    function openMapModal() {
        const modal = document.getElementById('mapModal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // 배경 스크롤 방지
    }
    // 위성 모달 닫기 함수
    function closeMapModal() {
        const modal = document.getElementById('mapModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // 배경 스크롤 허용
    }


    // 2. AI 브리핑 음성 합성 기능
    function speakBriefing() {
        const text = document.getElementById('aiBriefingText').innerText;
        if (!text) {
            alert('읽어줄 브리핑 내용이 없습니다.');
            return;
        }
        const speech = new SpeechSynthesisUtterance();
        speech.text = text;
        speech.lang = 'ko-KR';
        speech.rate = 1.0;
        speech.pitch = 1.0;
        speech.volume = 1.0;
        const voices = window.speechSynthesis.getVoices();
        const koVoice = voices.find(v => v.lang.includes('ko') || v.name.includes('Google 한국어'));
        if (koVoice) {
            speech.voice = koVoice;
        }
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(speech);
    }

    // 3. AI 매니저 접기/펼치기 기능
    function toggleAiManager() {
        const content = document.getElementById('aiManagerContent');
        const icon = document.getElementById('aiToggleIcon');

        // 현재 max-height가 0인지(접힌 상태인지) 확인하는 로직
        // Tailwind 클래스 토글 방식 사용
        if (content.classList.contains('max-h-0')) {
            // 펼치기
            content.classList.remove('max-h-0', 'opacity-0');
            content.classList.add('max-h-[1000px]', 'opacity-100');
            icon.classList.remove('rotate-180');
        } else {
            // 접기
            content.classList.remove('max-h-[1000px]', 'opacity-100');
            content.classList.add('max-h-0', 'opacity-0');
            icon.classList.add('rotate-180');
        }
    }

    // 4. 맨 위로 가기 버튼 기능
    const backToTopBtn = document.getElementById('backToTopBtn');

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
            backToTopBtn.classList.add('opacity-100', 'translate-y-0');
        } else {
            backToTopBtn.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            backToTopBtn.classList.remove('opacity-100', 'translate-y-0');
        }
    });
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 5. 태양 위치 애니메이션 업데이트 함수
    function updateSunPosition() {
        // Thymeleaf 변수 주입 (서버에서 계산된 진행률)
        /*[# th:if="${weather.sunProgress != null}"]*/
        let progress = /*[[${weather.sunProgress}]]*/ 0;
        /*[/]*/
        /*[# th:unless="${weather.sunProgress != null}"]*/
        let progress = 0;
        /*[/]*/

        const pathLength = 251.2; // Circumference of semicircle r=40
        const offset = pathLength - (pathLength * (progress / 100));

        // 1. 프로그레스 바 채우기
        const progressPath = document.getElementById('sunProgressPath');
        if (progressPath) {
            progressPath.style.strokeDashoffset = offset;
        }

        // 2. 태양 아이콘 위치 이동
        // Path: M 10 50 A 40 40 0 0 1 90 50
        // Center: (50, 50), Radius: 40
        // Angle goes from 180 deg (left) to 0 deg (right)
        // Progress 0% -> 180 deg, 100% -> 0 deg

        const angleDeg = 180 - (180 * (progress / 100));
        const angleRad = angleDeg * (Math.PI / 180);

        // x = cx + r * cos(a), y = cy - r * sin(a) (SVG y is down, so minus for up)
        const cx = 50;
        const cy = 50;
        const r = 40;

        const x = cx + r * Math.cos(angleRad); // cos(180)=-1 -> x=10
        const y = cy - r * Math.sin(angleRad); // sin(180)=0 -> y=50, sin(90)=1 -> y=10

        const sunGroup = document.getElementById('sunIconGroup');
        if (sunGroup) {
            sunGroup.style.transition = "transform 2s ease-out";
            sunGroup.style.transformBox = "view-box"; // SVG 좌표계 기준
            // transform 속성을 직접 변경하거나, x/y 좌표를 변경하지 않고 translate 사용
            // 하지만 SVG transform은 origin이 중요함.
            // 간단하게는 JS로 translate 문자열 생성
            // 초기 위치가 0,0 이므로 x,y 만큼 이동

            // 애니메이션을 위해 setTimeout 사용
            setTimeout(() => {
                sunGroup.setAttribute("transform", `translate(${x}, ${y})`);
            }, 100);
        }
    }

    // 6. Chart.js 그래프 생성
    document.addEventListener("DOMContentLoaded", function() {
        window.speechSynthesis.getVoices();

        // Sun Position Update
        updateSunPosition();

        const ctx = document.getElementById('weatherChart');
        if (!ctx) return;
        const labels = [];
        const tempPoints = [];
        const humidityPoints = [];
        /*[# th:each="item : ${weather.shortTermForecasts}"]*/
            labels.push(/*[[${#strings.substring(item.fcstTime, 0, 2)} + ':00']]*/ "12:00");
            tempPoints.push(/*[[${item.T1H}]]*/ 20);
            humidityPoints.push(/*[[${item.REH}]]*/ 50);
        /*[/]*/
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '기온 (°C)',
                        data: tempPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f6',
                        yAxisID: 'y',
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '습도 (%)',
                        data: humidityPoints,
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, font: { family: "'Noto Sans KR', sans-serif" } } },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1e293b',
                        bodyColor: '#1e293b',
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        padding: 10,
                        bodyFont: { family: "'Noto Sans KR', sans-serif" },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += context.parsed.y;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: '기온 (°C)', color: '#3b82f6', font: {size: 11, weight: 'bold'} },
                        grid: { color: '#f1f5f9' },
                        ticks: { color: '#3b82f6' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: '습도 (%)', color: '#a855f7', font: {size: 11, weight: 'bold'} },
                        grid: { display: false },
                        min: 0,
                        max: 100,
                        ticks: { color: '#a855f7' }
                    },
                    x: { grid: { display: false }, ticks: { color: '#64748b' } }
                }
            }
        });
    });

    const modal = document.getElementById('predictModal');
    const iframe = document.getElementById('predictFrame');

    // 모달 열기 함수
    function openModal() {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // iframe 내부의 resetAll 함수 호출 (새로고침 없이 값만 초기화)
        if (iframe && iframe.contentWindow.resetAll) {
            iframe.contentWindow.resetAll();
        }
    }
    // 모달 닫기 함수
    function closeModal() {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';

        // 닫을 때도 미리 비워두면 다음에 열 때 더 깔끔합니다.
        if (iframe && iframe.contentWindow.resetAll) {
            iframe.contentWindow.resetAll();
        }
    }

    window.onkeydown = function(event) {
        if (event.key === "Escape" && !modal.classList.contains('hidden')) {
            closeModal();
        }
    };
</script>
</body>
</html>