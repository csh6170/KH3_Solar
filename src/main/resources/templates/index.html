<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI íƒœì–‘ê´‘ ë°œì „ ì˜ˆì¸¡</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- [Dark Mode Config] -->
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; transition: background-color 0.3s, color 0.3s; }

        /* w.html ìŠ¤íƒ€ì¼ì˜ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ (Bootstrap ì œê±°ë¡œ ì¸í•´ ìˆ˜ë™ êµ¬í˜„) */
        .spinner-border {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: -0.125em;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: .75s linear infinite spinner-border;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 min-h-screen p-0 text-gray-800 dark:text-gray-100">

<div class="w-full min-h-screen bg-white dark:bg-slate-900 flex flex-col transition-colors duration-300">

    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-8 text-white text-center relative overflow-hidden shrink-0">
        <div class="relative z-10">
            <div class="text-6xl mb-4 text-yellow-300 drop-shadow-md">
                <i class="fas fa-solar-panel animate-pulse"></i>
            </div>
            <h2 class="text-2xl font-bold tracking-tight">íƒœì–‘ê´‘ ë°œì „ ì˜ˆì¸¡</h2>
            <p class="text-blue-100 text-sm mt-2 font-medium opacity-90">ì§€ì—­ê³¼ ì„¤ë¹„ ìš©ëŸ‰ë§Œ ì…ë ¥í•˜ì„¸ìš”!</p>
        </div>
    </div>

    <div class="p-8">
        <form action="/predict" method="get" id="predictForm" class="space-y-6">

            <div>
                <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2 flex items-center text-sm">
                    <i class="fas fa-map-marker-alt text-blue-500 mr-2"></i>ìœ„ì¹˜ ì„ íƒ
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <select id="region1" name="region1" class="w-full p-3 bg-gray-50 dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 text-gray-700 dark:text-white font-medium focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition appearance-none">
                            <option value="">ì‹œ/ë„</option>
                            <option th:each="r : ${region1List}" th:value="${r}" th:text="${r}"></option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 dark:text-gray-400"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>

                    <div class="relative">
                        <select id="region2" name="region2" disabled class="w-full p-3 bg-gray-100 dark:bg-slate-700/50 rounded-xl border border-gray-200 dark:border-slate-700 text-gray-400 dark:text-gray-500 font-medium focus:ring-2 focus:ring-blue-500 outline-none transition appearance-none disabled:opacity-70 disabled:cursor-not-allowed">
                            <option value="">ì‹œ/êµ¬/êµ°</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400 dark:text-gray-500"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>
                </div>
                <div id="weatherStatus" class="text-right text-xs font-bold mt-2 h-5 text-gray-500 dark:text-gray-400"></div>
            </div>

            <div>
                <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2 flex items-center text-sm">
                    <i class="fas fa-bolt text-yellow-500 mr-2"></i>ì„¤ë¹„ ìš©ëŸ‰ (kW)
                </label>
                <div class="relative">
                    <input type="number" name="capacity" id="capacity" step="0.1" disabled
                           class="w-full p-4 pl-12 bg-gray-100 dark:bg-slate-700/50 rounded-xl border border-gray-200 dark:border-slate-700 text-gray-800 dark:text-white font-bold placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:bg-white dark:focus:bg-slate-800 outline-none transition disabled:cursor-not-allowed"
                           placeholder="ì§€ì—­ ì„ íƒ í›„ ì…ë ¥ ê°€ëŠ¥">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-plug text-gray-400"></i></div>
                </div>
            </div>

            <input type="hidden" name="temp" id="inputTemp"> <input type="hidden" name="cloud" id="inputCloud">
            <input type="hidden" name="radiation" id="inputRadiation">
            <input type="hidden" name="humidity" id="inputHumidity">
            <input type="hidden" name="rain" id="inputRain">
            <input type="hidden" name="snow" id="inputSnow">
            <input type="hidden" name="wind" id="inputWind">
            <input type="hidden" name="sunshine" id="inputSunshine">
            <input type="hidden" name="lat" id="inputLat">
            <input type="hidden" name="lon" id="inputLon">

            <div class="bg-blue-50 dark:bg-slate-800 rounded-xl p-3 flex items-center gap-3 border border-blue-100 dark:border-slate-700 mb-4 transition-colors">
                <i class="fas fa-calculator text-blue-500"></i>
                <p class="text-[15px] text-blue-800 dark:text-blue-300 leading-tight">
                    <strong>ì•Œê³ ë¦¬ì¦˜ ì •ë°€ ë¶„ì„:</strong> ê¸°ìƒì²­ì˜ ë‚´ì¼ ë‚ ì”¨(12ì‹œ ê¸°ì¤€)ì™€ <strong>ìµœì €/ìµœê³  ê¸°ì˜¨</strong>ì„ ë°˜ì˜í•˜ì—¬ ì˜ˆì¸¡í•©ë‹ˆë‹¤.
                </p>
            </div>

            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                <span>ë‚´ì¼ ë°œì „ëŸ‰ ì˜ˆì¸¡í•˜ê¸°</span>
                <i class="fas fa-rocket"></i>
            </button>
        </form>
    </div>

    <div class="mt-auto bg-gray-50 dark:bg-slate-800 p-6 text-center border-t border-gray-100 dark:border-slate-700 transition-colors">
        <div th:replace="~{footer :: copyright}"></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    const region1Select = document.getElementById('region1');
    const region2Select = document.getElementById('region2');
    const capacityInput = document.getElementById('capacity');
    const statusDiv = document.getElementById('weatherStatus');

    // [1] ì‹œ/ë„ ì„ íƒ ì‹œ
    region1Select.addEventListener('change', function() {
        const region1 = this.value;
        region2Select.innerHTML = '<option value="">ì‹œ/êµ¬/êµ°</option>';
        region2Select.disabled = true;
        statusDiv.innerText = '';

        capacityInput.disabled = true;
        capacityInput.value = '';
        capacityInput.placeholder = "ì§€ì—­ ì„ íƒ í›„ ì…ë ¥ ê°€ëŠ¥";

        // ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ í† ê¸€ ì¶”ê°€
        capacityInput.classList.add('bg-gray-100', 'dark:bg-slate-700/50');
        capacityInput.classList.remove('bg-white', 'dark:bg-slate-800');

        resetWeatherInputs();

        if (region1) {
            fetch('/api/region2?region1=' + encodeURIComponent(region1))
                .then(res => res.json())
                .then(data => {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.text = item;
                        region2Select.appendChild(option);
                    });
                    region2Select.disabled = false;
                    // ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ í† ê¸€ ì¶”ê°€
                    region2Select.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-slate-700/50', 'dark:text-gray-500');
                    region2Select.classList.add('bg-gray-50', 'text-gray-700', 'dark:bg-slate-800', 'dark:text-white');
                });
        }
    });

    // [2] ì‹œ/êµ¬/êµ° ì„ íƒ ì‹œ -> ë‚ ì”¨ ì¡°íšŒ
    region2Select.addEventListener('change', function() {
        const r1 = region1Select.value;
        const r2 = this.value;

        if (!r1 || !r2) return;

        capacityInput.disabled = true;
        statusDiv.className = 'text-right text-xs font-bold mt-2 h-5 text-gray-500 dark:text-gray-400';
        statusDiv.innerHTML = '<span class="spinner-border"></span> ê¸°ìƒì²­ ë°ì´í„° ì¡°íšŒ ì¤‘...';

        fetch(`/api/weather?region1=${encodeURIComponent(r1)}&region2=${encodeURIComponent(r2)}`)
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    statusDiv.className = 'text-right text-xs font-bold mt-2 h-5 text-red-500';
                    statusDiv.innerText = 'âŒ ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                    Swal.fire('ì˜¤ë¥˜', data.error, 'error');
                } else {
                    document.getElementById('inputTemp').value = data.temp;
                    document.getElementById('inputCloud').value = data.cloud;
                    document.getElementById('inputRadiation').value = data.radiation;
                    document.getElementById('inputHumidity').value = data.humidity;
                    document.getElementById('inputRain').value = data.rain || "0";
                    document.getElementById('inputSnow').value = data.snow || "0";
                    document.getElementById('inputWind').value = data.wind || "2.0";
                    document.getElementById('inputSunshine').value = data.sunshine || "0.5";
                    document.getElementById('inputLat').value = data.lat;
                    document.getElementById('inputLon').value = data.lon;

                    const minT = data.minTemp !== undefined ? data.minTemp : '?';
                    const maxT = data.maxTemp !== undefined ? data.maxTemp : '?';

                    let weatherText = "ë§‘ìŒ â˜€ï¸";
                    const pop = data.pop ? parseInt(data.pop) : 0;
                    const cloud = parseFloat(data.cloud) || 0;

                    if (pop >= 90) {
                        if (data.snow && data.snow !== "0") weatherText = "ëˆˆ ğŸŒ¨ï¸";
                        else weatherText = "ë¹„ â˜”";
                    } else if (pop > 0) {
                        weatherText = `ê°•ìˆ˜í™•ë¥  ${pop}% â˜‚ï¸`;
                    } else {
                        if (cloud >= 6) weatherText = "íë¦¼ â˜ï¸";
                        else if (cloud >= 3) weatherText = "êµ¬ë¦„ ì¡°ê¸ˆ â›…";
                        else weatherText = "ë§‘ìŒ â˜€ï¸";
                    }

                    statusDiv.className = 'text-right text-[15px] font-bold mt-2 h-5 text-indigo-600 dark:text-indigo-400';
                    statusDiv.innerHTML = `
                        <span>${weatherText} (ğŸ“‰${minT}Â°C / ğŸ“ˆ${maxT}Â°C)</span>
                        <span class="ml-1 text-[10px] text-gray-400 dark:text-gray-500 font-normal">[ê²©ì:${data.nx},${data.ny}]</span>
                    `;

                    capacityInput.disabled = false;
                    capacityInput.placeholder = "ì˜ˆ: 3";

                    // ë‹¤í¬ëª¨ë“œ í´ë˜ìŠ¤ í† ê¸€ ì¶”ê°€
                    capacityInput.classList.remove('bg-gray-100', 'dark:bg-slate-700/50');
                    capacityInput.classList.add('bg-white', 'dark:bg-slate-800');
                    capacityInput.focus();
                }
            })
            .catch(err => {
                console.error(err);
                statusDiv.innerText = 'âŒ í†µì‹  ì˜¤ë¥˜';
            });
    });

    function resetWeatherInputs() {
        document.getElementById('inputTemp').value = '';
        document.getElementById('inputCloud').value = '';
        // ë‚˜ë¨¸ì§€ input ì´ˆê¸°í™”ëŠ” ìƒëµí•´ë„ ë¡œì§ìƒ ë¬¸ì œì—†ìŒ
    }

    document.getElementById('predictForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const capacity = document.getElementById('capacity').value;
        const temp = document.getElementById('inputTemp').value;

        if (!capacity || parseFloat(capacity) <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'ì…ë ¥ í™•ì¸',
                text: 'ì„¤ë¹„ ìš©ëŸ‰(kW)ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!',
                confirmButtonColor: '#4f46e5'
            });
            return;
        }

        if (!temp) {
            Swal.fire({
                icon: 'warning',
                title: 'ì§€ì—­ ì„ íƒ í•„ìš”',
                text: 'ì§€ì—­ì„ ì„ íƒí•˜ì—¬ ë‚ ì”¨ ì •ë³´ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.',
                confirmButtonColor: '#4f46e5'
            });
            return;
        }

        Swal.fire({
            title: 'ë°œì „ëŸ‰ ì˜ˆì¸¡ ì¤‘...',
            text: 'AIê°€ ë‚ ì”¨ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.',
            icon: 'info',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        this.submit();
    });

    window.resetAll = function() {
        const form = document.getElementById('predictForm');
        if (form) form.reset();

        const region2Select = document.getElementById('region2');
        const capacityInput = document.getElementById('capacity');
        const statusDiv = document.getElementById('weatherStatus');

        if (region2Select) {
            region2Select.innerHTML = '<option value="">ì‹œ/êµ¬/êµ°</option>';
            region2Select.disabled = true;
            region2Select.classList.add('bg-gray-100', 'text-gray-400', 'dark:bg-slate-700/50', 'dark:text-gray-500');
            region2Select.classList.remove('bg-gray-50', 'dark:bg-slate-800', 'dark:text-white');
        }

        if (capacityInput) {
            capacityInput.disabled = true;
            capacityInput.placeholder = "ì§€ì—­ ì„ íƒ í›„ ì…ë ¥ ê°€ëŠ¥";
            capacityInput.classList.add('bg-gray-100', 'dark:bg-slate-700/50');
            capacityInput.classList.remove('bg-white', 'dark:bg-slate-800');
        }
        if (statusDiv) statusDiv.innerText = '';
    };
</script>

</body>
</html>