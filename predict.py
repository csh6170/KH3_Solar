import sys
import io
import pandas as pd
import joblib
import json
import os
import math
import datetime
import requests
import time
import csv
import asyncio
import threading
from geopy.geocoders import Nominatim
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

# ==================================================================================
# [ê¸°ë³¸ ì„¤ì •] ì¸ì½”ë”© ë° ë²„í¼ë§ ê°•ì œ ì„¤ì •
# ==================================================================================
sys.stdout = io.TextIOWrapper(sys.stdout.detach(), encoding='utf-8', line_buffering=True)
sys.stderr = io.TextIOWrapper(sys.stderr.detach(), encoding='utf-8', line_buffering=True)

# ==================================================================================
# [ë¡œê·¸ ì €ì¥ ê¸°ëŠ¥] ì‚¬ìš©ì ê²€ìƒ‰ ê¸°ë¡ ê´€ë¦¬ (ìŠ¤ë ˆë“œ ì•ˆì „ ë²„ì „)
# ==================================================================================
LOG_FILE = "user_history.csv"
log_lock = threading.Lock() # <--- [2] ìë¬¼ì‡  ìƒì„± (ì „ì—­ ë³€ìˆ˜)

def save_user_log(user_id, user_name, input_text, result_status):
    """
    ì‚¬ìš©ìì˜ ê²€ìƒ‰ ê¸°ë¡ì„ CSV íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤. (ë™ì‹œ ì ‘ê·¼ ë°©ì§€ ì ìš©)
    """
    now = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    file_exists = os.path.isfile(LOG_FILE)
    
    try:
        # [3] íŒŒì¼ì„ ì—´ê¸° ì „ì— ìë¬¼ì‡ ë¥¼ ì ê¸ˆ (ë‹¤ë¥¸ ë†ˆë“¤ì€ ëŒ€ê¸°)
        with log_lock: 
            with open(LOG_FILE, mode='a', newline='', encoding='utf-8-sig') as f:
                writer = csv.writer(f)
                if not file_exists:
                    writer.writerow(["ì‹œê°„", "ì‚¬ìš©ìID", "ì´ë¦„", "ì…ë ¥í•œëª…ë ¹ì–´", "ì²˜ë¦¬ê²°ê³¼"])
                writer.writerow([now, user_id, user_name, input_text, result_status])
    except Exception as e:
        print(f"[ì‹œìŠ¤í…œ ë¡œê·¸] ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨: {e}")

# ---------------------------------------------------------
# 1. ëª¨ë¸ ë¡œë“œ
# ---------------------------------------------------------
current_folder = os.path.dirname(os.path.abspath(__file__))
model_path = os.path.join(current_folder, 'data', 'solar_model.pkl')

if not os.path.exists(model_path):
    print(json.dumps({"error": "ëª¨ë¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}))
    sys.exit(1)

model = joblib.load(model_path)

# ---------------------------------------------------------
# 2. ì¼ì‚¬ëŸ‰ ê³„ì‚°ê¸°
# ---------------------------------------------------------
def calculate_theoretical_radiation(lat, lon, date, hour, cloud_cover_score):
    doy = date.timetuple().tm_yday
    declination = 23.45 * math.sin(math.radians(360 * (284 + doy) / 365))
    hour_angle = (hour - 12) * 15

    lat_rad = math.radians(lat)
    dec_rad = math.radians(declination)
    ha_rad = math.radians(hour_angle)

    sin_elevation = (math.sin(lat_rad) * math.sin(dec_rad)) + \
                    (math.cos(lat_rad) * math.cos(dec_rad) * math.cos(ha_rad))
    elevation = math.degrees(math.asin(max(0, sin_elevation)))

    if elevation <= 0: return 0.0, 0.0

    max_radiation = 3.6 * math.sin(math.radians(elevation))
    cloud_factor = 1.0 - (cloud_cover_score / 10.0 * 0.7)
    estimated_radiation = max_radiation * cloud_factor
    estimated_sunshine = 1.0 if cloud_cover_score <= 5 else 0.0

    return round(estimated_radiation, 2), estimated_sunshine

# ---------------------------------------------------------
# 3. ê¸°ìƒì²­ API
# ---------------------------------------------------------
SERVICE_KEY = "your_key"

def map_to_grid(lat, lon):
    RE = 6371.00877
    GRID = 5.0
    SLAT1 = 30.0
    SLAT2 = 60.0
    OLON = 126.0
    OLAT = 38.0
    XO = 43
    YO = 136

    DEGRAD = math.pi / 180.0
    re = RE / GRID
    slat1 = SLAT1 * DEGRAD
    slat2 = SLAT2 * DEGRAD
    olat = OLAT * DEGRAD
    olon = OLON * DEGRAD

    sn = math.tan(math.pi * 0.25 + slat2 * 0.5) / math.tan(math.pi * 0.25 + slat1 * 0.5)
    sn = math.log(math.cos(slat1) / math.cos(slat2)) / math.log(sn)
    sf = math.tan(math.pi * 0.25 + slat1 * 0.5)
    sf = (sf ** sn) * math.cos(slat1) / sn
    ro = math.tan(math.pi * 0.25 + olat * 0.5)
    ro = re * sf / (ro ** sn)
    ra = math.tan(math.pi * 0.25 + (lat) * DEGRAD * 0.5)
    ra = re * sf / (ra ** sn)

    theta = lon * DEGRAD - olon
    if theta > math.pi: theta -= 2.0 * math.pi
    if theta < -math.pi: theta += 2.0 * math.pi
    theta *= sn

    x = int(ra * math.sin(theta) + XO + 0.5)
    y = int(ro - ra * math.cos(theta) + YO + 0.5)

    return x, y

def get_kma_weather_full(lat, lon):
    nx, ny = map_to_grid(lat, lon)
    now = datetime.datetime.now()
    base_date = now.strftime("%Y%m%d")
    tomorrow_str = (now + datetime.timedelta(days=1)).strftime("%Y%m%d")

    url = "http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst"
    params = {
        "serviceKey": SERVICE_KEY,
        "pageNo": "1",
        "numOfRows": "1000",
        "dataType": "JSON",
        "base_date": base_date,
        "base_time": "0500",
        "nx": str(nx),
        "ny": str(ny)
    }

    for attempt in range(3):
        try:
            response = requests.get(url, params=params, timeout=10)
            
            # [ì•ˆì •ì„±] 429 ì—ëŸ¬(ì ‘ì† í­ì£¼) ì‹œ 2ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
            if response.status_code == 429:
                time.sleep(2)
                continue
            
            if response.status_code != 200: return None

            res = response.json()
            items = res['response']['body']['items']['item']

            min_temp = None
            max_temp = None
            data_12 = {'SKY': 1, 'PTY': 0, 'WSD': 2.0, 'REH': 60.0}

            for item in items:
                if item['fcstDate'] == tomorrow_str:
                    cat = item['category']
                    val = item['fcstValue']
                    if cat == 'TMN': min_temp = float(val)
                    if cat == 'TMX': max_temp = float(val)
                    if item['fcstTime'] == '1200' and cat in data_12:
                        data_12[cat] = float(val)

            if min_temp is None: min_temp = 0.0
            if max_temp is None: max_temp = 20.0
            avg_temp = (min_temp + max_temp) / 2.0

            sky_code = int(data_12['SKY'])
            cloud = 0 if sky_code == 1 else (5 if sky_code == 3 else 10)
            rad, sun = calculate_theoretical_radiation(lat, lon, now + datetime.timedelta(days=1), 12, cloud)

            return {
                'temp': avg_temp, 'min_temp': min_temp, 'max_temp': max_temp,
                'cloud': float(cloud), 'wind': data_12['WSD'], 'humidity': data_12['REH'],
                'sunshine': sun, 'radiation': rad,
                'snow': 5.0 if data_12['PTY'] == 3 else 0.0,
                'rain': 5.0 if data_12['PTY'] in [1,2,4] else 0.0
            }
        except Exception as e:
            # ì—ëŸ¬ ì›ì¸ì„ ì½˜ì†”ì— ì¶œë ¥í•´ì„œ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
            print(f"[API ì˜¤ë¥˜] {attempt+1}ì°¨ ì‹œë„ ì‹¤íŒ¨: {e}") 
            time.sleep(1)
            
    return None

def get_lat_lon_from_address(address):
    geolocator = Nominatim(user_agent="Solar_Power_Bot_v1")
    try:
        location = geolocator.geocode(f"ëŒ€í•œë¯¼êµ­ {address}")
        if location: return location.latitude, location.longitude
        return None, None
    except: return None, None

# ---------------------------------------------------------
# 4. í†µí•© ì§€ì—­ ë§µ (ì „êµ­ + ìƒì„¸ êµ¬ + ë³„ì¹­) [ì™„ì „íŒ]
# ---------------------------------------------------------
# [ìì£¼ ì“°ëŠ” ìƒì„¸ ì¢Œí‘œ ë³€ìˆ˜í™”]
coords_jinhae = {"lat": 35.1485, "lon": 128.6642}
coords_bundang = {"lat": 37.3827, "lon": 127.1189}
coords_suwon_jangan = {"lat": 37.3041, "lon": 127.0102}

REGION_MAP = {
    # 1. ê´‘ì—­ì‹œ/ë„ ë‹¨ìœ„
    "ì„œìš¸": {"lat": 37.5636, "lon": 126.9800}, "ë¶€ì‚°": {"lat": 35.1770, "lon": 129.0770},
    "ëŒ€êµ¬": {"lat": 35.8685, "lon": 128.6036}, "ì¸ì²œ": {"lat": 37.4532, "lon": 126.7074},
    "ê´‘ì£¼": {"lat": 35.1569, "lon": 126.8533}, "ëŒ€ì „": {"lat": 36.3471, "lon": 127.3880},
    "ìš¸ì‚°": {"lat": 35.5354, "lon": 129.3137}, "ì„¸ì¢…": {"lat": 36.4800, "lon": 127.2891},
    "ê²½ê¸°": {"lat": 37.2718, "lon": 127.0117}, "ê°•ì›": {"lat": 37.8604, "lon": 127.7298},
    "ì¶©ë¶": {"lat": 36.6325, "lon": 127.4936}, "ì¶©ë‚¨": {"lat": 36.6553, "lon": 126.6728},
    "ì „ë¶": {"lat": 35.8215, "lon": 127.1112}, "ì „ë‚¨": {"lat": 34.8130, "lon": 126.4650},
    "ê²½ë¶": {"lat": 36.5730, "lon": 128.5056}, "ê²½ë‚¨": {"lat": 35.2347, "lon": 128.6942},
    "ì œì£¼": {"lat": 33.4857, "lon": 126.5003},

    # 2. ì„œìš¸íŠ¹ë³„ì‹œ (êµ¬ ë‹¨ìœ„ ë° ë³„ì¹­)
    "ì„œìš¸ ì¢…ë¡œêµ¬": {"lat": 37.5704, "lon": 126.9816}, "ì¢…ë¡œêµ¬": {"lat": 37.5704, "lon": 126.9816},
    "ì„œìš¸ ì¤‘êµ¬": {"lat": 37.5610, "lon": 126.9996},
    "ì„œìš¸ ìš©ì‚°êµ¬": {"lat": 37.5361, "lon": 126.9675}, "ìš©ì‚°êµ¬": {"lat": 37.5361, "lon": 126.9675},
    "ì„œìš¸ ì„±ë™êµ¬": {"lat": 37.5606, "lon": 127.0390}, "ì„±ë™êµ¬": {"lat": 37.5606, "lon": 127.0390},
    "ì„œìš¸ ê´‘ì§„êµ¬": {"lat": 37.5357, "lon": 127.0845}, "ê´‘ì§„êµ¬": {"lat": 37.5357, "lon": 127.0845},
    "ì„œìš¸ ë™ëŒ€ë¬¸êµ¬": {"lat": 37.5716, "lon": 127.0421}, "ë™ëŒ€ë¬¸êµ¬": {"lat": 37.5716, "lon": 127.0421},
    "ì„œìš¸ ì¤‘ë‘êµ¬": {"lat": 37.6038, "lon": 127.0948}, "ì¤‘ë‘êµ¬": {"lat": 37.6038, "lon": 127.0948},
    "ì„œìš¸ ì„±ë¶êµ¬": {"lat": 37.5864, "lon": 127.0203}, "ì„±ë¶êµ¬": {"lat": 37.5864, "lon": 127.0203},
    "ì„œìš¸ ê°•ë¶êµ¬": {"lat": 37.6370, "lon": 127.0277}, "ê°•ë¶êµ¬": {"lat": 37.6370, "lon": 127.0277},
    "ì„œìš¸ ë„ë´‰êµ¬": {"lat": 37.6658, "lon": 127.0495}, "ë„ë´‰êµ¬": {"lat": 37.6658, "lon": 127.0495},
    "ì„œìš¸ ë…¸ì›êµ¬": {"lat": 37.6515, "lon": 127.0584}, "ë…¸ì›êµ¬": {"lat": 37.6515, "lon": 127.0584},
    "ì„œìš¸ ì€í‰êµ¬": {"lat": 37.6000, "lon": 126.9312}, "ì€í‰êµ¬": {"lat": 37.6000, "lon": 126.9312},
    "ì„œìš¸ ì„œëŒ€ë¬¸êµ¬": {"lat": 37.5764, "lon": 126.9389}, "ì„œëŒ€ë¬¸êµ¬": {"lat": 37.5764, "lon": 126.9389},
    "ì„œìš¸ ë§ˆí¬êµ¬": {"lat": 37.5607, "lon": 126.9105}, "ë§ˆí¬êµ¬": {"lat": 37.5607, "lon": 126.9105},
    "ì„œìš¸ ì–‘ì²œêµ¬": {"lat": 37.5142, "lon": 126.8687}, "ì–‘ì²œêµ¬": {"lat": 37.5142, "lon": 126.8687},
    "ì„œìš¸ ê°•ì„œêµ¬": {"lat": 37.5482, "lon": 126.8517}, "ê°•ì„œêµ¬": {"lat": 37.5482, "lon": 126.8517},
    "ì„œìš¸ êµ¬ë¡œêµ¬": {"lat": 37.4926, "lon": 126.8896}, "êµ¬ë¡œêµ¬": {"lat": 37.4926, "lon": 126.8896},
    "ì„œìš¸ ê¸ˆì²œêµ¬": {"lat": 37.4491, "lon": 126.9042}, "ê¸ˆì²œêµ¬": {"lat": 37.4491, "lon": 126.9042},
    "ì„œìš¸ ì˜ë“±í¬êµ¬": {"lat": 37.5236, "lon": 126.8983}, "ì˜ë“±í¬êµ¬": {"lat": 37.5236, "lon": 126.8983},
    "ì„œìš¸ ë™ì‘êµ¬": {"lat": 37.5097, "lon": 126.9416}, "ë™ì‘êµ¬": {"lat": 37.5097, "lon": 126.9416},
    "ì„œìš¸ ê´€ì•…êµ¬": {"lat": 37.4754, "lon": 126.9538}, "ê´€ì•…êµ¬": {"lat": 37.4754, "lon": 126.9538},
    "ì„œìš¸ ì„œì´ˆêµ¬": {"lat": 37.4808, "lon": 127.0348}, "ì„œì´ˆêµ¬": {"lat": 37.4808, "lon": 127.0348},
    "ì„œìš¸ ê°•ë‚¨êµ¬": {"lat": 37.5146, "lon": 127.0496}, "ê°•ë‚¨êµ¬": {"lat": 37.5146, "lon": 127.0496},
    "ì„œìš¸ ì†¡íŒŒêµ¬": {"lat": 37.5118, "lon": 127.1079}, "ì†¡íŒŒêµ¬": {"lat": 37.5118, "lon": 127.1079},
    "ì„œìš¸ ê°•ë™êµ¬": {"lat": 37.5274, "lon": 127.1259}, "ê°•ë™êµ¬": {"lat": 37.5274, "lon": 127.1259},

    # 3. ë¶€ì‚°ê´‘ì—­ì‹œ (êµ¬/êµ° ë° ë³„ì¹­)
    "ë¶€ì‚° ì¤‘êµ¬": {"lat": 35.1032, "lon": 129.0345}, 
    "ë¶€ì‚° ì„œêµ¬": {"lat": 35.0948, "lon": 129.0264},
    "ë¶€ì‚° ë™êµ¬": {"lat": 35.1359, "lon": 129.0592}, 
    "ë¶€ì‚° ì˜ë„êµ¬": {"lat": 35.0881, "lon": 129.0702}, "ì˜ë„êµ¬": {"lat": 35.0881, "lon": 129.0702},
    "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬": {"lat": 35.1600, "lon": 129.0553}, "ë¶€ì‚°ì§„êµ¬": {"lat": 35.1600, "lon": 129.0553},
    "ë¶€ì‚° ë™ë˜êµ¬": {"lat": 35.2019, "lon": 129.0859}, "ë™ë˜êµ¬": {"lat": 35.2019, "lon": 129.0859},
    "ë¶€ì‚° ë‚¨êµ¬": {"lat": 35.1334, "lon": 129.0865}, 
    "ë¶€ì‚° ë¶êµ¬": {"lat": 35.1942, "lon": 128.9925},
    "ë¶€ì‚° í•´ìš´ëŒ€êµ¬": {"lat": 35.1600, "lon": 129.1658}, "í•´ìš´ëŒ€êµ¬": {"lat": 35.1600, "lon": 129.1658}, "í•´ìš´ëŒ€": {"lat": 35.1600, "lon": 129.1658},
    "ë¶€ì‚° ì‚¬í•˜êµ¬": {"lat": 35.1014, "lon": 128.9770}, "ì‚¬í•˜êµ¬": {"lat": 35.1014, "lon": 128.9770},
    "ë¶€ì‚° ê¸ˆì •êµ¬": {"lat": 35.2401, "lon": 129.0943}, "ê¸ˆì •êµ¬": {"lat": 35.2401, "lon": 129.0943},
    "ë¶€ì‚° ê°•ì„œêµ¬": {"lat": 35.2092, "lon": 128.9829}, 
    "ë¶€ì‚° ì—°ì œêµ¬": {"lat": 35.1732, "lon": 129.0821}, "ì—°ì œêµ¬": {"lat": 35.1732, "lon": 129.0821},
    "ë¶€ì‚° ìˆ˜ì˜êµ¬": {"lat": 35.1425, "lon": 129.1154}, "ìˆ˜ì˜êµ¬": {"lat": 35.1425, "lon": 129.1154},
    "ë¶€ì‚° ì‚¬ìƒêµ¬": {"lat": 35.1495, "lon": 128.9933}, "ì‚¬ìƒêµ¬": {"lat": 35.1495, "lon": 128.9933},
    "ë¶€ì‚° ê¸°ì¥êµ°": {"lat": 35.2414, "lon": 129.2245}, "ê¸°ì¥êµ°": {"lat": 35.2414, "lon": 129.2245},

    # 4. ëŒ€êµ¬ê´‘ì—­ì‹œ (êµ¬/êµ° ë° ë³„ì¹­)
    "ëŒ€êµ¬ ì¤‘êµ¬": {"lat": 35.8663, "lon": 128.6084},
    "ëŒ€êµ¬ ë™êµ¬": {"lat": 35.8836, "lon": 128.6377},
    "ëŒ€êµ¬ ì„œêµ¬": {"lat": 35.8758, "lon": 128.5529},
    "ëŒ€êµ¬ ë‚¨êµ¬": {"lat": 35.8431, "lon": 128.5910},
    "ëŒ€êµ¬ ë¶êµ¬": {"lat": 35.8906, "lon": 128.5822},
    "ëŒ€êµ¬ ìˆ˜ì„±êµ¬": {"lat": 35.8552, "lon": 128.6322}, "ìˆ˜ì„±êµ¬": {"lat": 35.8552, "lon": 128.6322},
    "ëŒ€êµ¬ ë‹¬ì„œêµ¬": {"lat": 35.8267, "lon": 128.5323}, "ë‹¬ì„œêµ¬": {"lat": 35.8267, "lon": 128.5323},
    "ëŒ€êµ¬ ë‹¬ì„±êµ°": {"lat": 35.7720, "lon": 128.4316}, "ë‹¬ì„±êµ°": {"lat": 35.7720, "lon": 128.4316},
    "ëŒ€êµ¬ êµ°ìœ„êµ°": {"lat": 36.2393, "lon": 128.5728}, "êµ°ìœ„êµ°": {"lat": 36.2393, "lon": 128.5728},

    # 5. ì¸ì²œê´‘ì—­ì‹œ (êµ¬/êµ° ë° ë³„ì¹­)
    "ì¸ì²œ ì¤‘êµ¬": {"lat": 37.4707, "lon": 126.6235},
    "ì¸ì²œ ë™êµ¬": {"lat": 37.4712, "lon": 126.6326},
    "ì¸ì²œ ë¯¸ì¶”í™€êµ¬": {"lat": 37.4607, "lon": 126.6502}, "ë¯¸ì¶”í™€êµ¬": {"lat": 37.4607, "lon": 126.6502},
    "ì¸ì²œ ì—°ìˆ˜êµ¬": {"lat": 37.4072, "lon": 126.6781}, "ì—°ìˆ˜êµ¬": {"lat": 37.4072, "lon": 126.6781},
    "ì¸ì²œ ë‚¨ë™êµ¬": {"lat": 37.4439, "lon": 126.7325}, "ë‚¨ë™êµ¬": {"lat": 37.4439, "lon": 126.7325},
    "ì¸ì²œ ë¶€í‰êµ¬": {"lat": 37.5042, "lon": 126.7218}, "ë¶€í‰êµ¬": {"lat": 37.5042, "lon": 126.7218},
    "ì¸ì²œ ê³„ì–‘êµ¬": {"lat": 37.5345, "lon": 126.7371}, "ê³„ì–‘êµ¬": {"lat": 37.5345, "lon": 126.7371},
    "ì¸ì²œ ì„œêµ¬": {"lat": 37.5422, "lon": 126.6756},
    "ì¸ì²œ ê°•í™”êµ°": {"lat": 37.7429, "lon": 126.4878}, "ê°•í™”êµ°": {"lat": 37.7429, "lon": 126.4878},
    "ì¸ì²œ ì˜¹ì§„êµ°": {"lat": 37.4466, "lon": 126.6368}, "ì˜¹ì§„êµ°": {"lat": 37.4466, "lon": 126.6368},

    # 6. ê´‘ì£¼ê´‘ì—­ì‹œ (êµ¬ ë° ë³„ì¹­)
    "ê´‘ì£¼ ë™êµ¬": {"lat": 35.1432, "lon": 126.9231},
    "ê´‘ì£¼ ì„œêµ¬": {"lat": 35.1492, "lon": 126.8525},
    "ê´‘ì£¼ ë‚¨êµ¬": {"lat": 35.1293, "lon": 126.9036},
    "ê´‘ì£¼ ë¶êµ¬": {"lat": 35.1714, "lon": 126.9079},
    "ê´‘ì£¼ ê´‘ì‚°êµ¬": {"lat": 35.1363, "lon": 126.7917}, "ê´‘ì‚°êµ¬": {"lat": 35.1363, "lon": 126.7917},

    # 7. ëŒ€ì „ê´‘ì—­ì‹œ (êµ¬ ë° ë³„ì¹­)
    "ëŒ€ì „ ë™êµ¬": {"lat": 36.3087, "lon": 127.4526},
    "ëŒ€ì „ ì¤‘êµ¬": {"lat": 36.3225, "lon": 127.4205},
    "ëŒ€ì „ ì„œêµ¬": {"lat": 36.3524, "lon": 127.3789},
    "ëŒ€ì „ ìœ ì„±êµ¬": {"lat": 36.3594, "lon": 127.3583}, "ìœ ì„±êµ¬": {"lat": 36.3594, "lon": 127.3583},
    "ëŒ€ì „ ëŒ€ë•êµ¬": {"lat": 36.3438, "lon": 127.4177}, "ëŒ€ë•êµ¬": {"lat": 36.3438, "lon": 127.4177},

    # 8. ìš¸ì‚°ê´‘ì—­ì‹œ (êµ¬/êµ° ë° ë³„ì¹­)
    "ìš¸ì‚° ì¤‘êµ¬": {"lat": 35.5663, "lon": 129.3349},
    "ìš¸ì‚° ë‚¨êµ¬": {"lat": 35.5408, "lon": 129.3324},
    "ìš¸ì‚° ë™êµ¬": {"lat": 35.5019, "lon": 129.4190},
    "ìš¸ì‚° ë¶êµ¬": {"lat": 35.5797, "lon": 129.3635},
    "ìš¸ì‚° ìš¸ì£¼êµ°": {"lat": 35.5307, "lon": 129.2972}, "ìš¸ì£¼êµ°": {"lat": 35.5307, "lon": 129.2972},

    # 9. ê²½ê¸°ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ê²½ê¸° ìˆ˜ì›ì‹œ": {"lat": 37.3010, "lon": 127.0122}, "ìˆ˜ì›ì‹œ": {"lat": 37.3010, "lon": 127.0122}, "ìˆ˜ì›": {"lat": 37.3010, "lon": 127.0122},
    "ê²½ê¸° ì„±ë‚¨ì‹œ": {"lat": 37.4171, "lon": 127.1265}, "ì„±ë‚¨ì‹œ": {"lat": 37.4171, "lon": 127.1265}, "ì„±ë‚¨": {"lat": 37.4171, "lon": 127.1265},
    "ê²½ê¸° ì˜ì •ë¶€ì‹œ": {"lat": 37.7352, "lon": 127.0337}, "ì˜ì •ë¶€ì‹œ": {"lat": 37.7352, "lon": 127.0337}, "ì˜ì •ë¶€": {"lat": 37.7352, "lon": 127.0337},
    "ê²½ê¸° ì•ˆì–‘ì‹œ": {"lat": 37.3917, "lon": 126.9265}, "ì•ˆì–‘ì‹œ": {"lat": 37.3917, "lon": 126.9265}, "ì•ˆì–‘": {"lat": 37.3917, "lon": 126.9265},
    "ê²½ê¸° ë¶€ì²œì‹œ": {"lat": 37.4994, "lon": 126.7656}, "ë¶€ì²œì‹œ": {"lat": 37.4994, "lon": 126.7656}, "ë¶€ì²œ": {"lat": 37.4994, "lon": 126.7656},
    "ê²½ê¸° ê´‘ëª…ì‹œ": {"lat": 37.4756, "lon": 126.8646}, "ê´‘ëª…ì‹œ": {"lat": 37.4756, "lon": 126.8646}, "ê´‘ëª…": {"lat": 37.4756, "lon": 126.8646},
    "ê²½ê¸° í‰íƒì‹œ": {"lat": 36.9882, "lon": 127.1128}, "í‰íƒì‹œ": {"lat": 36.9882, "lon": 127.1128}, "í‰íƒ": {"lat": 36.9882, "lon": 127.1128},
    "ê²½ê¸° ë™ë‘ì²œì‹œ": {"lat": 37.9004, "lon": 127.0549}, "ë™ë‘ì²œì‹œ": {"lat": 37.9004, "lon": 127.0549},
    "ê²½ê¸° ì•ˆì‚°ì‹œ": {"lat": 37.3193, "lon": 126.8288}, "ì•ˆì‚°ì‹œ": {"lat": 37.3193, "lon": 126.8288}, "ì•ˆì‚°": {"lat": 37.3193, "lon": 126.8288},
    "ê²½ê¸° ê³ ì–‘ì‹œ": {"lat": 37.6556, "lon": 126.8350}, "ê³ ì–‘ì‹œ": {"lat": 37.6556, "lon": 126.8350}, "ê³ ì–‘": {"lat": 37.6556, "lon": 126.8350},
    "ê²½ê¸° ê³¼ì²œì‹œ": {"lat": 37.4262, "lon": 126.9897}, "ê³¼ì²œì‹œ": {"lat": 37.4262, "lon": 126.9897}, "ê³¼ì²œ": {"lat": 37.4262, "lon": 126.9897},
    "ê²½ê¸° êµ¬ë¦¬ì‹œ": {"lat": 37.5913, "lon": 127.1356}, "êµ¬ë¦¬ì‹œ": {"lat": 37.5913, "lon": 127.1356}, "êµ¬ë¦¬": {"lat": 37.5913, "lon": 127.1356},
    "ê²½ê¸° ë‚¨ì–‘ì£¼ì‹œ": {"lat": 37.6331, "lon": 127.2165}, "ë‚¨ì–‘ì£¼ì‹œ": {"lat": 37.6331, "lon": 127.2165}, "ë‚¨ì–‘ì£¼": {"lat": 37.6331, "lon": 127.2165},
    "ê²½ê¸° ì˜¤ì‚°ì‹œ": {"lat": 37.1469, "lon": 127.0673}, "ì˜¤ì‚°ì‹œ": {"lat": 37.1469, "lon": 127.0673}, "ì˜¤ì‚°": {"lat": 37.1469, "lon": 127.0673},
    "ê²½ê¸° ì‹œí¥ì‹œ": {"lat": 37.3773, "lon": 126.8023}, "ì‹œí¥ì‹œ": {"lat": 37.3773, "lon": 126.8023}, "ì‹œí¥": {"lat": 37.3773, "lon": 126.8023},
    "ê²½ê¸° êµ°í¬ì‹œ": {"lat": 37.3585, "lon": 126.9351}, "êµ°í¬ì‹œ": {"lat": 37.3585, "lon": 126.9351}, "êµ°í¬": {"lat": 37.3585, "lon": 126.9351},
    "ê²½ê¸° ì˜ì™•ì‹œ": {"lat": 37.3418, "lon": 126.9729}, "ì˜ì™•ì‹œ": {"lat": 37.3418, "lon": 126.9729}, "ì˜ì™•": {"lat": 37.3418, "lon": 126.9729},
    "ê²½ê¸° í•˜ë‚¨ì‹œ": {"lat": 37.5362, "lon": 127.2137}, "í•˜ë‚¨ì‹œ": {"lat": 37.5362, "lon": 127.2137}, "í•˜ë‚¨": {"lat": 37.5362, "lon": 127.2137},
    "ê²½ê¸° ìš©ì¸ì‹œ": {"lat": 37.2382, "lon": 127.1902}, "ìš©ì¸ì‹œ": {"lat": 37.2382, "lon": 127.1902}, "ìš©ì¸": {"lat": 37.2382, "lon": 127.1902},
    "ê²½ê¸° íŒŒì£¼ì‹œ": {"lat": 37.7565, "lon": 126.7780}, "íŒŒì£¼ì‹œ": {"lat": 37.7565, "lon": 126.7780}, "íŒŒì£¼": {"lat": 37.7565, "lon": 126.7780},
    "ê²½ê¸° ì´ì²œì‹œ": {"lat": 37.2764, "lon": 127.4397}, "ì´ì²œì‹œ": {"lat": 37.2764, "lon": 127.4397}, "ì´ì²œ": {"lat": 37.2764, "lon": 127.4397},
    "ê²½ê¸° ì•ˆì„±ì‹œ": {"lat": 37.0050, "lon": 127.2796}, "ì•ˆì„±ì‹œ": {"lat": 37.0050, "lon": 127.2796}, "ì•ˆì„±": {"lat": 37.0050, "lon": 127.2796},
    "ê²½ê¸° ê¹€í¬ì‹œ": {"lat": 37.6121, "lon": 126.7112}, "ê¹€í¬ì‹œ": {"lat": 37.6121, "lon": 126.7112}, "ê¹€í¬": {"lat": 37.6121, "lon": 126.7112},
    "ê²½ê¸° í™”ì„±ì‹œ": {"lat": 37.1966, "lon": 126.8281}, "í™”ì„±ì‹œ": {"lat": 37.1966, "lon": 126.8281}, "í™”ì„±": {"lat": 37.1966, "lon": 126.8281},
    "ê²½ê¸° ê´‘ì£¼ì‹œ": {"lat": 37.4263, "lon": 127.2515}, "ê´‘ì£¼ì‹œ": {"lat": 37.4263, "lon": 127.2515},
    "ê²½ê¸° ì–‘ì£¼ì‹œ": {"lat": 37.7824, "lon": 127.0429}, "ì–‘ì£¼ì‹œ": {"lat": 37.7824, "lon": 127.0429},
    "ê²½ê¸° í¬ì²œì‹œ": {"lat": 37.8919, "lon": 127.2003}, "í¬ì²œì‹œ": {"lat": 37.8919, "lon": 127.2003},
    "ê²½ê¸° ì—¬ì£¼ì‹œ": {"lat": 37.2952, "lon": 127.6366}, "ì—¬ì£¼ì‹œ": {"lat": 37.2952, "lon": 127.6366},
    "ê²½ê¸° ì—°ì²œêµ°": {"lat": 38.0935, "lon": 127.0745}, "ì—°ì²œêµ°": {"lat": 38.0935, "lon": 127.0745},
    "ê²½ê¸° ê°€í‰êµ°": {"lat": 37.8287, "lon": 127.5109}, "ê°€í‰êµ°": {"lat": 37.8287, "lon": 127.5109},
    "ê²½ê¸° ì–‘í‰êµ°": {"lat": 37.4886, "lon": 127.4913}, "ì–‘í‰êµ°": {"lat": 37.4886, "lon": 127.4913},

    # 10. ê°•ì›íŠ¹ë³„ìì¹˜ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ê°•ì› ì¶˜ì²œì‹œ": {"lat": 37.8785, "lon": 127.7298}, "ì¶˜ì²œ": {"lat": 37.8785, "lon": 127.7298},
    "ê°•ì› ì›ì£¼ì‹œ": {"lat": 37.3392, "lon": 127.9453}, "ì›ì£¼": {"lat": 37.3392, "lon": 127.9453},
    "ê°•ì› ê°•ë¦‰ì‹œ": {"lat": 37.7491, "lon": 128.8759}, "ê°•ë¦‰": {"lat": 37.7491, "lon": 128.8759},
    "ê°•ì› ë™í•´ì‹œ": {"lat": 37.5218, "lon": 129.1143}, "ë™í•´ì‹œ": {"lat": 37.5218, "lon": 129.1143}, "ë™í•´": {"lat": 37.5218, "lon": 129.1143},
    "ê°•ì› íƒœë°±ì‹œ": {"lat": 37.1611, "lon": 128.9856}, "íƒœë°±": {"lat": 37.1611, "lon": 128.9856},
    "ê°•ì› ì†ì´ˆì‹œ": {"lat": 38.2043, "lon": 128.5918}, "ì†ì´ˆ": {"lat": 38.2043, "lon": 128.5918},
    "ê°•ì› ì‚¼ì²™ì‹œ": {"lat": 37.4468, "lon": 129.1650}, "ì‚¼ì²™": {"lat": 37.4468, "lon": 129.1650},
    "ê°•ì› í™ì²œêµ°": {"lat": 37.6944, "lon": 127.8908}, "í™ì²œ": {"lat": 37.6944, "lon": 127.8908},
    "ê°•ì› íš¡ì„±êµ°": {"lat": 37.4889, "lon": 127.9872}, "íš¡ì„±": {"lat": 37.4889, "lon": 127.9872},
    "ê°•ì› ì˜ì›”êµ°": {"lat": 37.1808, "lon": 128.4619}, "ì˜ì›”": {"lat": 37.1808, "lon": 128.4619},
    "ê°•ì› í‰ì°½êµ°": {"lat": 37.3674, "lon": 128.3902}, "í‰ì°½": {"lat": 37.3674, "lon": 128.3902},
    "ê°•ì› ì •ì„ êµ°": {"lat": 37.3776, "lon": 128.6607}, "ì •ì„ ": {"lat": 37.3776, "lon": 128.6607},
    "ê°•ì› ì² ì›êµ°": {"lat": 38.2033, "lon": 127.3739}, "ì² ì›": {"lat": 38.2033, "lon": 127.3739},
    "ê°•ì› í™”ì²œêµ°": {"lat": 38.1032, "lon": 127.7082}, "í™”ì²œ": {"lat": 38.1032, "lon": 127.7082},
    "ê°•ì› ì–‘êµ¬êµ°": {"lat": 38.1065, "lon": 127.9893}, "ì–‘êµ¬": {"lat": 38.1065, "lon": 127.9893},
    "ê°•ì› ì¸ì œêµ°": {"lat": 38.0667, "lon": 128.1703}, "ì¸ì œ": {"lat": 38.0667, "lon": 128.1703},
    "ê°•ì› ê³ ì„±êµ°": {"lat": 38.3776, "lon": 128.4678},
    "ê°•ì› ì–‘ì–‘êµ°": {"lat": 38.0724, "lon": 128.6183}, "ì–‘ì–‘": {"lat": 38.0724, "lon": 128.6183},

    # 11. ì¶©ì²­ë¶ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ì¶©ë¶ ì²­ì£¼ì‹œ": {"lat": 36.6396, "lon": 127.4887}, "ì²­ì£¼": {"lat": 36.6396, "lon": 127.4887},
    "ì¶©ë¶ ì¶©ì£¼ì‹œ": {"lat": 36.9882, "lon": 127.9260}, "ì¶©ì£¼": {"lat": 36.9882, "lon": 127.9260},
    "ì¶©ë¶ ì œì²œì‹œ": {"lat": 37.1298, "lon": 128.2065}, "ì œì²œ": {"lat": 37.1298, "lon": 128.2065},
    "ì¶©ë¶ ë³´ì€êµ°": {"lat": 36.4864, "lon": 127.7177}, "ë³´ì€": {"lat": 36.4864, "lon": 127.7177},
    "ì¶©ë¶ ì˜¥ì²œêµ°": {"lat": 36.3033, "lon": 127.5647}, "ì˜¥ì²œ": {"lat": 36.3033, "lon": 127.5647},
    "ì¶©ë¶ ì˜ë™êµ°": {"lat": 36.1720, "lon": 127.7774}, "ì˜ë™": {"lat": 36.1720, "lon": 127.7774},
    "ì¶©ë¶ ì¦í‰êµ°": {"lat": 36.7823, "lon": 127.5814}, "ì¦í‰": {"lat": 36.7823, "lon": 127.5814},
    "ì¶©ë¶ ì§„ì²œêµ°": {"lat": 36.8523, "lon": 127.4406}, "ì§„ì²œ": {"lat": 36.8523, "lon": 127.4406},
    "ì¶©ë¶ ê´´ì‚°êµ°": {"lat": 36.8124, "lon": 127.7924}, "ê´´ì‚°": {"lat": 36.8124, "lon": 127.7924},
    "ì¶©ë¶ ìŒì„±êµ°": {"lat": 36.9377, "lon": 127.6905}, "ìŒì„±": {"lat": 36.9377, "lon": 127.6905},
    "ì¶©ë¶ ë‹¨ì–‘êµ°": {"lat": 36.9815, "lon": 128.3655}, "ë‹¨ì–‘": {"lat": 36.9815, "lon": 128.3655},

    # 12. ì¶©ì²­ë‚¨ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ì¶©ë‚¨ ì²œì•ˆì‹œ": {"lat": 36.8121, "lon": 127.1139}, "ì²œì•ˆ": {"lat": 36.8121, "lon": 127.1139},
    "ì¶©ë‚¨ ê³µì£¼ì‹œ": {"lat": 36.4435, "lon": 127.1189}, "ê³µì£¼": {"lat": 36.4435, "lon": 127.1189},
    "ì¶©ë‚¨ ë³´ë ¹ì‹œ": {"lat": 36.3303, "lon": 126.6128}, "ë³´ë ¹": {"lat": 36.3303, "lon": 126.6128},
    "ì¶©ë‚¨ ì•„ì‚°ì‹œ": {"lat": 36.7868, "lon": 126.9987}, "ì•„ì‚°": {"lat": 36.7868, "lon": 126.9987},
    "ì¶©ë‚¨ ì„œì‚°ì‹œ": {"lat": 36.7818, "lon": 126.4503}, "ì„œì‚°": {"lat": 36.7818, "lon": 126.4503},
    "ì¶©ë‚¨ ë…¼ì‚°ì‹œ": {"lat": 36.1843, "lon": 127.0987}, "ë…¼ì‚°": {"lat": 36.1843, "lon": 127.0987},
    "ì¶©ë‚¨ ê³„ë£¡ì‹œ": {"lat": 36.2711, "lon": 127.2525}, "ê³„ë£¡": {"lat": 36.2711, "lon": 127.2525},
    "ì¶©ë‚¨ ë‹¹ì§„ì‹œ": {"lat": 36.8906, "lon": 126.6293}, "ë‹¹ì§„": {"lat": 36.8906, "lon": 126.6293},
    "ì¶©ë‚¨ ê¸ˆì‚°êµ°": {"lat": 36.1057, "lon": 127.4883}, "ê¸ˆì‚°": {"lat": 36.1057, "lon": 127.4883},
    "ì¶©ë‚¨ ë¶€ì—¬êµ°": {"lat": 36.2725, "lon": 126.9129}, "ë¶€ì—¬": {"lat": 36.2725, "lon": 126.9129},
    "ì¶©ë‚¨ ì„œì²œêµ°": {"lat": 36.0772, "lon": 126.6908}, "ì„œì²œ": {"lat": 36.0772, "lon": 126.6908},
    "ì¶©ë‚¨ ì²­ì–‘êµ°": {"lat": 36.4561, "lon": 126.8026}, "ì²­ì–‘": {"lat": 36.4561, "lon": 126.8026},
    "ì¶©ë‚¨ í™ì„±êµ°": {"lat": 36.5986, "lon": 126.6577}, "í™ì„±": {"lat": 36.5986, "lon": 126.6577},
    "ì¶©ë‚¨ ì˜ˆì‚°êµ°": {"lat": 36.6774, "lon": 126.8486}, "ì˜ˆì‚°": {"lat": 36.6774, "lon": 126.8486},
    "ì¶©ë‚¨ íƒœì•ˆêµ°": {"lat": 36.7513, "lon": 126.2972}, "íƒœì•ˆ": {"lat": 36.7513, "lon": 126.2972},

    # 13. ì „ë¶íŠ¹ë³„ìì¹˜ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ì „ë¶ ì „ì£¼ì‹œ": {"lat": 35.8215, "lon": 127.1480}, "ì „ì£¼": {"lat": 35.8215, "lon": 127.1480},
    "ì „ë¶ êµ°ì‚°ì‹œ": {"lat": 35.9647, "lon": 126.7360}, "êµ°ì‚°": {"lat": 35.9647, "lon": 126.7360},
    "ì „ë¶ ìµì‚°ì‹œ": {"lat": 35.9454, "lon": 126.9542}, "ìµì‚°": {"lat": 35.9454, "lon": 126.9542},
    "ì „ë¶ ì •ìì‹œ": {"lat": 35.5666, "lon": 126.8531}, "ì •ì": {"lat": 35.5666, "lon": 126.8531},
    "ì „ë¶ ë‚¨ì›ì‹œ": {"lat": 35.4134, "lon": 127.3905}, "ë‚¨ì›": {"lat": 35.4134, "lon": 127.3905},
    "ì „ë¶ ê¹€ì œì‹œ": {"lat": 35.7998, "lon": 126.8817}, "ê¹€ì œ": {"lat": 35.7998, "lon": 126.8817},
    "ì „ë¶ ì™„ì£¼êµ°": {"lat": 35.9017, "lon": 127.1627}, "ì™„ì£¼": {"lat": 35.9017, "lon": 127.1627},
    "ì „ë¶ ì§„ì•ˆêµ°": {"lat": 35.7884, "lon": 127.4258}, "ì§„ì•ˆ": {"lat": 35.7884, "lon": 127.4258},
    "ì „ë¶ ë¬´ì£¼êµ°": {"lat": 36.0039, "lon": 127.6607}, "ë¬´ì£¼": {"lat": 36.0039, "lon": 127.6607},
    "ì „ë¶ ì¥ìˆ˜êµ°": {"lat": 35.6443, "lon": 127.5189}, "ì¥ìˆ˜": {"lat": 35.6443, "lon": 127.5189},
    "ì „ë¶ ì„ì‹¤êµ°": {"lat": 35.6143, "lon": 127.2889}, "ì„ì‹¤": {"lat": 35.6143, "lon": 127.2889},
    "ì „ë¶ ìˆœì°½êµ°": {"lat": 35.3713, "lon": 127.1447}, "ìˆœì°½": {"lat": 35.3713, "lon": 127.1447},
    "ì „ë¶ ê³ ì°½êµ°": {"lat": 35.4328, "lon": 126.7022}, "ê³ ì°½": {"lat": 35.4328, "lon": 126.7022},
    "ì „ë¶ ë¶€ì•ˆêµ°": {"lat": 35.7285, "lon": 126.7357}, "ë¶€ì•ˆ": {"lat": 35.7285, "lon": 126.7357},

    # 14. ì „ë¼ë‚¨ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ì „ë‚¨ ëª©í¬ì‹œ": {"lat": 34.8118, "lon": 126.3922}, "ëª©í¬": {"lat": 34.8118, "lon": 126.3922},
    "ì „ë‚¨ ì—¬ìˆ˜ì‹œ": {"lat": 34.7604, "lon": 127.6622}, "ì—¬ìˆ˜": {"lat": 34.7604, "lon": 127.6622},
    "ì „ë‚¨ ìˆœì²œì‹œ": {"lat": 34.9506, "lon": 127.4872}, "ìˆœì²œ": {"lat": 34.9506, "lon": 127.4872},
    "ì „ë‚¨ ë‚˜ì£¼ì‹œ": {"lat": 35.0161, "lon": 126.7108}, "ë‚˜ì£¼": {"lat": 35.0161, "lon": 126.7108},
    "ì „ë‚¨ ê´‘ì–‘ì‹œ": {"lat": 34.9407, "lon": 127.6959}, "ê´‘ì–‘": {"lat": 34.9407, "lon": 127.6959},
    "ì „ë‚¨ ë‹´ì–‘êµ°": {"lat": 35.3211, "lon": 126.9882}, "ë‹´ì–‘": {"lat": 35.3211, "lon": 126.9882},
    "ì „ë‚¨ ê³¡ì„±êµ°": {"lat": 35.2819, "lon": 127.2918}, "ê³¡ì„±": {"lat": 35.2819, "lon": 127.2918},
    "ì „ë‚¨ êµ¬ë¡€êµ°": {"lat": 35.2021, "lon": 127.4628}, "êµ¬ë¡€": {"lat": 35.2021, "lon": 127.4628},
    "ì „ë‚¨ ê³ í¥êµ°": {"lat": 34.6111, "lon": 127.2850}, "ê³ í¥": {"lat": 34.6111, "lon": 127.2850},
    "ì „ë‚¨ ë³´ì„±êµ°": {"lat": 34.7715, "lon": 127.0797}, "ë³´ì„±": {"lat": 34.7715, "lon": 127.0797},
    "ì „ë‚¨ í™”ìˆœêµ°": {"lat": 35.0645, "lon": 126.9863}, "í™”ìˆœ": {"lat": 35.0645, "lon": 126.9863},
    "ì „ë‚¨ ì¥í¥êµ°": {"lat": 34.6816, "lon": 126.9070}, "ì¥í¥": {"lat": 34.6816, "lon": 126.9070},
    "ì „ë‚¨ ê°•ì§„êµ°": {"lat": 34.6421, "lon": 126.7673}, "ê°•ì§„": {"lat": 34.6421, "lon": 126.7673},
    "ì „ë‚¨ í•´ë‚¨êµ°": {"lat": 34.5735, "lon": 126.5992}, "í•´ë‚¨": {"lat": 34.5735, "lon": 126.5992},
    "ì „ë‚¨ ì˜ì•”êµ°": {"lat": 34.8001, "lon": 126.6968}, "ì˜ì•”": {"lat": 34.8001, "lon": 126.6968},
    "ì „ë‚¨ ë¬´ì•ˆêµ°": {"lat": 34.9904, "lon": 126.4817}, "ë¬´ì•ˆ": {"lat": 34.9904, "lon": 126.4817},
    "ì „ë‚¨ í•¨í‰êµ°": {"lat": 35.0658, "lon": 126.5167}, "í•¨í‰": {"lat": 35.0658, "lon": 126.5167},
    "ì „ë‚¨ ì˜ê´‘êµ°": {"lat": 35.2773, "lon": 126.5120}, "ì˜ê´‘": {"lat": 35.2773, "lon": 126.5120},
    "ì „ë‚¨ ì¥ì„±êµ°": {"lat": 35.3018, "lon": 126.7850}, "ì¥ì„±": {"lat": 35.3018, "lon": 126.7850},
    "ì „ë‚¨ ì™„ë„êµ°": {"lat": 34.3110, "lon": 126.7550}, "ì™„ë„": {"lat": 34.3110, "lon": 126.7550},
    "ì „ë‚¨ ì§„ë„êµ°": {"lat": 34.4868, "lon": 126.2635}, "ì§„ë„": {"lat": 34.4868, "lon": 126.2635},
    "ì „ë‚¨ ì‹ ì•ˆêµ°": {"lat": 34.8336, "lon": 126.3514}, "ì‹ ì•ˆ": {"lat": 34.8336, "lon": 126.3514},

    # 15. ê²½ìƒë¶ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ê²½ë¶ í¬í•­ì‹œ": {"lat": 36.0190, "lon": 129.3435}, "í¬í•­": {"lat": 36.0190, "lon": 129.3435},
    "ê²½ë¶ ê²½ì£¼ì‹œ": {"lat": 35.8562, "lon": 129.2247}, "ê²½ì£¼": {"lat": 35.8562, "lon": 129.2247},
    "ê²½ë¶ ê¹€ì²œì‹œ": {"lat": 36.1398, "lon": 128.1136}, "ê¹€ì²œ": {"lat": 36.1398, "lon": 128.1136},
    "ê²½ë¶ ì•ˆë™ì‹œ": {"lat": 36.5684, "lon": 128.7294}, "ì•ˆë™": {"lat": 36.5684, "lon": 128.7294},
    "ê²½ë¶ êµ¬ë¯¸ì‹œ": {"lat": 36.1195, "lon": 128.3446}, "êµ¬ë¯¸": {"lat": 36.1195, "lon": 128.3446},
    "ê²½ë¶ ì˜ì£¼ì‹œ": {"lat": 36.8056, "lon": 128.6240}, "ì˜ì£¼": {"lat": 36.8056, "lon": 128.6240},
    "ê²½ë¶ ì˜ì²œì‹œ": {"lat": 35.9733, "lon": 128.9385}, "ì˜ì²œ": {"lat": 35.9733, "lon": 128.9385},
    "ê²½ë¶ ìƒì£¼ì‹œ": {"lat": 36.4109, "lon": 128.1591}, "ìƒì£¼": {"lat": 36.4109, "lon": 128.1591},
    "ê²½ë¶ ë¬¸ê²½ì‹œ": {"lat": 36.5865, "lon": 128.1867}, "ë¬¸ê²½": {"lat": 36.5865, "lon": 128.1867},
    "ê²½ë¶ ê²½ì‚°ì‹œ": {"lat": 35.8251, "lon": 128.7414}, "ê²½ì‚°": {"lat": 35.8251, "lon": 128.7414},
    "ê²½ë¶ ì˜ì„±êµ°": {"lat": 36.3527, "lon": 128.6971}, "ì˜ì„±": {"lat": 36.3527, "lon": 128.6971},
    "ê²½ë¶ ì²­ì†¡êµ°": {"lat": 36.4363, "lon": 129.0571}, "ì²­ì†¡": {"lat": 36.4363, "lon": 129.0571},
    "ê²½ë¶ ì˜ì–‘êµ°": {"lat": 36.6669, "lon": 129.1124}, "ì˜ì–‘": {"lat": 36.6669, "lon": 129.1124},
    "ê²½ë¶ ì˜ë•êµ°": {"lat": 36.4150, "lon": 129.3656}, "ì˜ë•": {"lat": 36.4150, "lon": 129.3656},
    "ê²½ë¶ ì²­ë„êµ°": {"lat": 35.6473, "lon": 128.7340}, "ì²­ë„": {"lat": 35.6473, "lon": 128.7340},
    "ê²½ë¶ ê³ ë ¹êµ°": {"lat": 35.7259, "lon": 128.2629}, "ê³ ë ¹": {"lat": 35.7259, "lon": 128.2629},
    "ê²½ë¶ ì„±ì£¼êµ°": {"lat": 35.9190, "lon": 128.2830}, "ì„±ì£¼": {"lat": 35.9190, "lon": 128.2830},
    "ê²½ë¶ ì¹ ê³¡êµ°": {"lat": 35.9610, "lon": 128.4005}, "ì¹ ê³¡": {"lat": 35.9610, "lon": 128.4005},
    "ê²½ë¶ ì˜ˆì²œêµ°": {"lat": 36.6558, "lon": 128.4526}, "ì˜ˆì²œ": {"lat": 36.6558, "lon": 128.4526},
    "ê²½ë¶ ë´‰í™”êµ°": {"lat": 36.8931, "lon": 128.7324}, "ë´‰í™”": {"lat": 36.8931, "lon": 128.7324},
    "ê²½ë¶ ìš¸ì§„êµ°": {"lat": 36.9930, "lon": 129.4004}, "ìš¸ì§„": {"lat": 36.9930, "lon": 129.4004},
    "ê²½ë¶ ìš¸ë¦‰êµ°": {"lat": 37.4844, "lon": 130.9056}, "ìš¸ë¦‰": {"lat": 37.4844, "lon": 130.9056},

    # 16. ê²½ìƒë‚¨ë„ (ì‹œ/êµ° ë° ë³„ì¹­)
    "ê²½ë‚¨ ì°½ì›ì‹œ": {"lat": 35.2279, "lon": 128.6818}, "ì°½ì›": {"lat": 35.2279, "lon": 128.6818},
    "ê²½ë‚¨ ì§„ì£¼ì‹œ": {"lat": 35.1802, "lon": 128.1076}, "ì§„ì£¼": {"lat": 35.1802, "lon": 128.1076},
    "ê²½ë‚¨ í†µì˜ì‹œ": {"lat": 34.8544, "lon": 128.4332}, "í†µì˜": {"lat": 34.8544, "lon": 128.4332},
    "ê²½ë‚¨ ì‚¬ì²œì‹œ": {"lat": 35.0038, "lon": 128.0642}, "ì‚¬ì²œ": {"lat": 35.0038, "lon": 128.0642},
    "ê²½ë‚¨ ê¹€í•´ì‹œ": {"lat": 35.2285, "lon": 128.8894}, "ê¹€í•´": {"lat": 35.2285, "lon": 128.8894},
    "ê²½ë‚¨ ë°€ì–‘ì‹œ": {"lat": 35.5038, "lon": 128.7466}, "ë°€ì–‘": {"lat": 35.5038, "lon": 128.7466},
    "ê²½ë‚¨ ê±°ì œì‹œ": {"lat": 34.8806, "lon": 128.6211}, "ê±°ì œ": {"lat": 34.8806, "lon": 128.6211},
    "ê²½ë‚¨ ì–‘ì‚°ì‹œ": {"lat": 35.3350, "lon": 129.0373}, "ì–‘ì‚°": {"lat": 35.3350, "lon": 129.0373},
    "ê²½ë‚¨ ì˜ë ¹êµ°": {"lat": 35.3221, "lon": 128.2618}, "ì˜ë ¹": {"lat": 35.3221, "lon": 128.2618},
    "ê²½ë‚¨ í•¨ì•ˆêµ°": {"lat": 35.2724, "lon": 128.4065}, "í•¨ì•ˆ": {"lat": 35.2724, "lon": 128.4065},
    "ê²½ë‚¨ ì°½ë…•êµ°": {"lat": 35.5446, "lon": 128.4922}, "ì°½ë…•": {"lat": 35.5446, "lon": 128.4922},
    "ê²½ë‚¨ ê³ ì„±êµ°": {"lat": 34.9731, "lon": 128.3223},
    "ê²½ë‚¨ ë‚¨í•´êµ°": {"lat": 34.8377, "lon": 127.8924}, "ë‚¨í•´": {"lat": 34.8377, "lon": 127.8924},
    "ê²½ë‚¨ í•˜ë™êµ°": {"lat": 35.0672, "lon": 127.7512}, "í•˜ë™": {"lat": 35.0672, "lon": 127.7512},
    "ê²½ë‚¨ ì‚°ì²­êµ°": {"lat": 35.4155, "lon": 127.8734}, "ì‚°ì²­": {"lat": 35.4155, "lon": 127.8734},
    "ê²½ë‚¨ í•¨ì–‘êµ°": {"lat": 35.5205, "lon": 127.7252}, "í•¨ì–‘": {"lat": 35.5205, "lon": 127.7252},
    "ê²½ë‚¨ ê±°ì°½êµ°": {"lat": 35.6865, "lon": 127.9098}, "ê±°ì°½": {"lat": 35.6865, "lon": 127.9098},
    "ê²½ë‚¨ í•©ì²œêµ°": {"lat": 35.5667, "lon": 128.1658}, "í•©ì²œ": {"lat": 35.5667, "lon": 128.1658},

    # 17. ì œì£¼íŠ¹ë³„ìì¹˜ë„ (ì‹œ ë° ë³„ì¹­)
    "ì œì£¼ ì œì£¼ì‹œ": {"lat": 33.4996, "lon": 126.5312}, "ì œì£¼": {"lat": 33.4996, "lon": 126.5312}, "ì œì£¼ì‹œ": {"lat": 33.4996, "lon": 126.5312},
    "ì œì£¼ ì„œê·€í¬ì‹œ": {"lat": 33.2541, "lon": 126.5601}, "ì„œê·€í¬": {"lat": 33.2541, "lon": 126.5601}, "ì„œê·€í¬ì‹œ": {"lat": 33.2541, "lon": 126.5601},

    # ---------------------------------------------------------
    # [ë³µêµ¬ ë° ì¶”ê°€] ëŒ€ë„ì‹œ ìƒì„¸ êµ¬(Gu) ë‹¨ìœ„ ë° ë³„ì¹­ ë§¤í•‘
    # ---------------------------------------------------------
    # ê²½ê¸° ìˆ˜ì›ì‹œ
    "ê²½ê¸° ìˆ˜ì› ì¥ì•ˆêµ¬": coords_suwon_jangan, "ìˆ˜ì› ì¥ì•ˆêµ¬": coords_suwon_jangan, "ì¥ì•ˆêµ¬": coords_suwon_jangan,
    "ê²½ê¸° ìˆ˜ì› ê¶Œì„ êµ¬": {"lat": 37.2576, "lon": 126.9720}, "ê¶Œì„ êµ¬": {"lat": 37.2576, "lon": 126.9720},
    "ê²½ê¸° ìˆ˜ì› íŒ”ë‹¬êµ¬": {"lat": 37.2825, "lon": 127.0200}, "íŒ”ë‹¬êµ¬": {"lat": 37.2825, "lon": 127.0200},
    "ê²½ê¸° ìˆ˜ì› ì˜í†µêµ¬": {"lat": 37.2596, "lon": 127.0736}, "ì˜í†µêµ¬": {"lat": 37.2596, "lon": 127.0736},

    # ê²½ê¸° ì„±ë‚¨ì‹œ
    "ê²½ê¸° ì„±ë‚¨ ìˆ˜ì •êµ¬": {"lat": 37.4485, "lon": 127.1407}, "ìˆ˜ì •êµ¬": {"lat": 37.4485, "lon": 127.1407},
    "ê²½ê¸° ì„±ë‚¨ ì¤‘ì›êµ¬": {"lat": 37.4304, "lon": 127.1873}, "ì¤‘ì›êµ¬": {"lat": 37.4304, "lon": 127.1873},
    "ê²½ê¸° ì„±ë‚¨ ë¶„ë‹¹êµ¬": coords_bundang, "ì„±ë‚¨ ë¶„ë‹¹êµ¬": coords_bundang, "ë¶„ë‹¹êµ¬": coords_bundang, "ë¶„ë‹¹": coords_bundang,

    # ê²½ê¸° ì•ˆì–‘ì‹œ
    "ê²½ê¸° ì•ˆì–‘ ë§Œì•ˆêµ¬": {"lat": 37.4072, "lon": 126.9113}, "ë§Œì•ˆêµ¬": {"lat": 37.4072, "lon": 126.9113},
    "ê²½ê¸° ì•ˆì–‘ ë™ì•ˆêµ¬": {"lat": 37.3907, "lon": 126.9616}, "ë™ì•ˆêµ¬": {"lat": 37.3907, "lon": 126.9616}, "í‰ì´Œ": {"lat": 37.3907, "lon": 126.9616},

    # ê²½ê¸° ì•ˆì‚°ì‹œ
    "ê²½ê¸° ì•ˆì‚° ìƒë¡êµ¬": {"lat": 37.3002, "lon": 126.8466}, "ìƒë¡êµ¬": {"lat": 37.3002, "lon": 126.8466},
    "ê²½ê¸° ì•ˆì‚° ë‹¨ì›êµ¬": {"lat": 37.3217, "lon": 126.8115}, "ë‹¨ì›êµ¬": {"lat": 37.3217, "lon": 126.8115},

    # ê²½ê¸° ê³ ì–‘ì‹œ
    "ê²½ê¸° ê³ ì–‘ ë•ì–‘êµ¬": {"lat": 37.6356, "lon": 126.8346}, "ë•ì–‘êµ¬": {"lat": 37.6356, "lon": 126.8346},
    "ê²½ê¸° ê³ ì–‘ ì¼ì‚°ë™êµ¬": {"lat": 37.6587, "lon": 126.7828}, "ì¼ì‚°ë™êµ¬": {"lat": 37.6587, "lon": 126.7828}, "ì¼ì‚°": {"lat": 37.6587, "lon": 126.7828},
    "ê²½ê¸° ê³ ì–‘ ì¼ì‚°ì„œêµ¬": {"lat": 37.6754, "lon": 126.7477}, "ì¼ì‚°ì„œêµ¬": {"lat": 37.6754, "lon": 126.7477},

    # ê²½ê¸° ìš©ì¸ì‹œ
    "ê²½ê¸° ìš©ì¸ ì²˜ì¸êµ¬": {"lat": 37.2343, "lon": 127.2013}, "ì²˜ì¸êµ¬": {"lat": 37.2343, "lon": 127.2013},
    "ê²½ê¸° ìš©ì¸ ê¸°í¥êµ¬": {"lat": 37.2797, "lon": 127.1147}, "ê¸°í¥êµ¬": {"lat": 37.2797, "lon": 127.1147},
    "ê²½ê¸° ìš©ì¸ ìˆ˜ì§€êµ¬": {"lat": 37.3220, "lon": 127.0977}, "ìˆ˜ì§€êµ¬": {"lat": 37.3220, "lon": 127.0977},

    # ì¶©ë¶ ì²­ì£¼ì‹œ
    "ì¶©ë¶ ì²­ì£¼ ìƒë‹¹êµ¬": {"lat": 36.6052, "lon": 127.5129}, "ìƒë‹¹êµ¬": {"lat": 36.6052, "lon": 127.5129},
    "ì¶©ë¶ ì²­ì£¼ ì„œì›êµ¬": {"lat": 36.6265, "lon": 127.4851}, "ì„œì›êµ¬": {"lat": 36.6265, "lon": 127.4851},
    "ì¶©ë¶ ì²­ì£¼ í¥ë•êµ¬": {"lat": 36.6357, "lon": 127.4416}, "í¥ë•êµ¬": {"lat": 36.6357, "lon": 127.4416},
    "ì¶©ë¶ ì²­ì£¼ ì²­ì›êµ¬": {"lat": 36.6833, "lon": 127.4727}, "ì²­ì›êµ¬": {"lat": 36.6833, "lon": 127.4727},

    # ì¶©ë‚¨ ì²œì•ˆì‹œ
    "ì¶©ë‚¨ ì²œì•ˆ ë™ë‚¨êµ¬": {"lat": 36.7863, "lon": 127.1643}, "ë™ë‚¨êµ¬": {"lat": 36.7863, "lon": 127.1643},
    "ì¶©ë‚¨ ì²œì•ˆ ì„œë¶êµ¬": {"lat": 36.8427, "lon": 127.1147}, "ì„œë¶êµ¬": {"lat": 36.8427, "lon": 127.1147},

    # ì „ë¶ ì „ì£¼ì‹œ
    "ì „ë¶ ì „ì£¼ ì™„ì‚°êµ¬": {"lat": 35.8117, "lon": 127.1437}, "ì™„ì‚°êµ¬": {"lat": 35.8117, "lon": 127.1437},
    "ì „ë¶ ì „ì£¼ ë•ì§„êµ¬": {"lat": 35.8454, "lon": 127.1287}, "ë•ì§„êµ¬": {"lat": 35.8454, "lon": 127.1287},

    # ê²½ë¶ í¬í•­ì‹œ
    "ê²½ë¶ í¬í•­ ë‚¨êµ¬": {"lat": 35.9926, "lon": 129.4007}, "ë‚¨êµ¬": {"lat": 35.9926, "lon": 129.4007},
    "ê²½ë¶ í¬í•­ ë¶êµ¬": {"lat": 36.0717, "lon": 129.3582}, "ë¶êµ¬": {"lat": 36.0717, "lon": 129.3582},

    # ê²½ë‚¨ ì°½ì›ì‹œ
    "ê²½ë‚¨ ì°½ì› ì§„í•´êµ¬": coords_jinhae, "ì°½ì› ì§„í•´êµ¬": coords_jinhae, "ì°½ì›ì‹œ ì§„í•´êµ¬": coords_jinhae, "ì§„í•´êµ¬": coords_jinhae, "ì§„í•´": coords_jinhae,
    "ê²½ë‚¨ ì°½ì› ì˜ì°½êµ¬": {"lat": 35.2536, "lon": 128.6397}, "ì˜ì°½êµ¬": {"lat": 35.2536, "lon": 128.6397},
    "ê²½ë‚¨ ì°½ì› ì„±ì‚°êµ¬": {"lat": 35.2163, "lon": 128.6823}, "ì„±ì‚°êµ¬": {"lat": 35.2163, "lon": 128.6823},
    "ê²½ë‚¨ ì°½ì› ë§ˆì‚°í•©í¬êµ¬": {"lat": 35.1837, "lon": 128.5639}, "ë§ˆì‚°í•©í¬êµ¬": {"lat": 35.1837, "lon": 128.5639}, "ë§ˆì‚°": {"lat": 35.1837, "lon": 128.5639},
    "ê²½ë‚¨ ì°½ì› ë§ˆì‚°íšŒì›êµ¬": {"lat": 35.2346, "lon": 128.5757}, "ë§ˆì‚°íšŒì›êµ¬": {"lat": 35.2346, "lon": 128.5757}
}

def calculate_solar_engine(lat, lon, weather_data, capacity_kw=1.0):
    base_temp = weather_data.get('temp', 20.0)
    cloud = weather_data.get('cloud', 5.0)
    wind = weather_data.get('wind', 2.0)
    humidity = weather_data.get('humidity', 60.0)
    snow = weather_data.get('snow', 0.0)
    rain = weather_data.get('rain', 0.0)
    target_date = datetime.datetime.now() + datetime.timedelta(days=1)
    
    total_daily_efficiency = 0.0
    hourly_results = []
    
    for hour in range(6, 20):
        curr_radiation, curr_sunshine = calculate_theoretical_radiation(lat, lon, target_date, hour, cloud)
        curr_temp = base_temp + (2.0 if 12 <= hour <= 15 else -2.0)
        
        input_data = pd.DataFrame({
            'ì‹œê°„': [hour], 'ìœ„ë„': [lat], 'ê²½ë„': [lon],
            'temp': [curr_temp], 'rain': [rain], 'wind': [wind],
            'humidity': [humidity], 'sunshine': [curr_sunshine],
            'radiation': [curr_radiation], 'snow': [snow], 'cloud': [cloud]
        })
        
        pred = model.predict(input_data)[0]
        if pred < 0: pred = 0.0
        total_daily_efficiency += pred
        hourly_results.append({"hour": hour, "value": round(pred, 3)})
        
    return round(total_daily_efficiency * capacity_kw, 4), hourly_results

if __name__ == '__main__':
    if len(sys.argv) > 1:
        # [CASE A: Java ì›¹ ì—°ë™] - ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
        try:
            lat = float(sys.argv[9])
            lon = float(sys.argv[10])
            weather_data = get_kma_weather_full(lat, lon)
            
            if weather_data is None:
                weather_data = {
                    'temp': float(sys.argv[1]), 'cloud': float(sys.argv[2]),
                    'wind': float(sys.argv[3]), 'humidity': float(sys.argv[4]),
                    'sunshine': float(sys.argv[5]), 'radiation': float(sys.argv[6]),
                    'snow': float(sys.argv[7]), 'rain': float(sys.argv[8])
                }
            
            total_gen, hourly_logs = calculate_solar_engine(lat, lon, weather_data, capacity_kw=1.0)
            print(json.dumps({ "total": total_gen, "hourly": hourly_logs }))
            
        except Exception as e:
            print(json.dumps({"error": str(e)}))
            
    else:
        # [CASE B: í…”ë ˆê·¸ë¨ ë´‡] - ë¹„ë™ê¸°(Async) ì‹¤í–‰
        print("[System] ë´‡ êµ¬ë™ ì¤€ë¹„ ì¤‘...")
        try:
            from telegram import Update
            from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
        except ImportError: sys.exit(1)
        
        TOKEN = 'your_token'

        async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
            await update.message.reply_text("ë°˜ê°‘ìŠµë‹ˆë‹¤! íƒœì–‘ê´‘ ë°œì „ ì˜ˆì¸¡ ë´‡ì…ë‹ˆë‹¤.\n\n[ì‚¬ìš©ë²•]\n/how [ì§€ì—­ëª…] [ìš©ëŸ‰]\nì˜ˆ: /how ì§„í•´ 3\nì˜ˆ: /how ë¶„ë‹¹ 3")

        async def predict_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
            now_str = datetime.datetime.now().strftime("%H:%M:%S")
            user = update.effective_user
            user_input_full = " ".join(context.args)
            
            try:
                user_input = context.args
                if len(user_input) < 2:
                    save_user_log(user.id, user.first_name, user_input_full, "ì…ë ¥ë¶€ì¡±")
                    await update.message.reply_text("[ì•ˆë‚´] ì‚¬ìš©ë²•: /how [ì§€ì—­ëª…] [ìš©ëŸ‰]\nì˜ˆ: /how ì„œìš¸ ì¢…ë¡œêµ¬ 3")
                    return
                
                try: capacity = float(user_input[-1])
                except ValueError:
                    save_user_log(user.id, user.first_name, user_input_full, "ìš©ëŸ‰ì…ë ¥ì˜¤ë¥˜")
                    await update.message.reply_text("[ì˜¤ë¥˜] ìš©ëŸ‰ì€ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.")
                    return
                
                region_name = " ".join(user_input[:-1])
                lat, lon = 0.0, 0.0
                
                if region_name in REGION_MAP:
                    lat = REGION_MAP[region_name]['lat']
                    lon = REGION_MAP[region_name]['lon']
                    save_user_log(user.id, user.first_name, user_input_full, "ë§µê²€ìƒ‰ì„±ê³µ")
                else:
                    await update.message.reply_text(f"[ê²€ìƒ‰] '{region_name}' ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...")
                    # ë¹„ë™ê¸° ë£¨í”„ì—ì„œ Blocking í•¨ìˆ˜(Geopy) ì‹¤í–‰
                    loop = asyncio.get_running_loop()
                    found_lat, found_lon = await loop.run_in_executor(None, get_lat_lon_from_address, region_name)
                    
                    if found_lat: 
                        lat, lon = found_lat, found_lon
                        save_user_log(user.id, user.first_name, user_input_full, "Geopyê²€ìƒ‰ì„±ê³µ")
                    else:
                        save_user_log(user.id, user.first_name, user_input_full, "ìœ„ì¹˜ëª»ì°¾ìŒ")
                        await update.message.reply_text("[ì˜¤ë¥˜] ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë™/ë¦¬ ë‹¨ìœ„ê¹Œì§€ ì…ë ¥í•´ë³´ì„¸ìš”)")
                        return
                
                print(f"[{now_str}] [ì¡°íšŒ] {region_name} ({lat:.2f}, {lon:.2f})")
                await update.message.reply_text(f"[ë¶„ì„] {region_name}ì˜ ë‚´ì¼ ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
                
                # ë¹„ë™ê¸° ë£¨í”„ì—ì„œ Blocking í•¨ìˆ˜(ê¸°ìƒì²­ API) ì‹¤í–‰
                loop = asyncio.get_running_loop()
                weather_data = await loop.run_in_executor(None, get_kma_weather_full, lat, lon)
                
                if not weather_data:
                    save_user_log(user.id, user.first_name, user_input_full, "ê¸°ìƒì²­APIì˜¤ë¥˜")
                    await update.message.reply_text("[ì˜¤ë¥˜] ê¸°ìƒì²­ ë°ì´í„° ì‹¤íŒ¨.")
                    return
                
                # ë¹„ë™ê¸° ë£¨í”„ì—ì„œ Blocking í•¨ìˆ˜(ëª¨ë¸ ì˜ˆì¸¡) ì‹¤í–‰
                gen, _ = await loop.run_in_executor(None, calculate_solar_engine, lat, lon, weather_data, capacity)
                profit = int(gen * 120)
                
                cloud_val = weather_data['cloud']
                rain_val = weather_data.get('rain', 0)
                snow_val = weather_data.get('snow', 0)
                
                status_text = "ë§‘ìŒ â˜€ï¸" if cloud_val <= 2 else ("êµ¬ë¦„ ì¡°ê¸ˆ ğŸŒ¤ï¸" if cloud_val <= 5 else ("êµ¬ë¦„ ë§ìŒ â˜ï¸" if cloud_val <= 8 else "íë¦¼ â˜ï¸"))
                if rain_val > 0: status_text = "ë¹„ ì†Œì‹ ìˆìŒ ğŸŒ§ï¸"
                if snow_val > 0: status_text = "ëˆˆ ì†Œì‹ ìˆìŒ â„ï¸"
                
                min_t = weather_data.get('min_temp', '?')
                max_t = weather_data.get('max_temp', '?')
                
                await update.message.reply_text(
                    f"[ë¶„ì„ ê²°ê³¼] {region_name} íƒœì–‘ê´‘ ì˜ˆì¸¡\n"
                    f"- ì„¤ë¹„ ìš©ëŸ‰: {capacity} kW\n"
                    f"-------------------------------\n"
                    f"- ë‚´ì¼ ê¸°ì˜¨: ìµœì € {min_t}Â°C / ìµœê³  {max_t}Â°C\n"
                    f"- ë‚ ì”¨ ìƒíƒœ: {status_text}\n"
                    f"-------------------------------\n"
                    f"* ì˜ˆìƒ ë°œì „ëŸ‰: {gen} kWh\n"
                    f"* ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡: ì•½ {format(profit, ',')} ì›"
                )
                print(f"[{now_str}] [ì„±ê³µ] ë°œì†¡ ì™„ë£Œ")
            
            except Exception as e:
                print(f"[ì—ëŸ¬] {e}")
                save_user_log(user.id, user.first_name, user_input_full, f"ì‹œìŠ¤í…œì—ëŸ¬:{e}")
                await update.message.reply_text("[ì˜¤ë¥˜] ì—ëŸ¬ ë°œìƒ.")

        app = ApplicationBuilder().token(TOKEN).build()
        app.add_handler(CommandHandler("start", start_command))
        app.add_handler(CommandHandler("how", predict_command))
        app.run_polling()